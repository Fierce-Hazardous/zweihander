function findDifference(e,a){let r=[];for(let t of e)a.some(e=>e.name===t.name)||r.push(t);return r}function getSymmetricDifference(e,t){return findDifference(e,t).concat(findDifference(t,e))}function isObjectEmpty$1(e){return!e||!Object.keys(e).length}const primaryAttributeMapping={C:"combat",B:"brawn",A:"agility",P:"perception",I:"intelligence",W:"willpower",F:"fellowship"};function abbreviations2DataPath(e,t=!0){var a,r;for(a in primaryAttributeMapping)e=e?.replace(`[${a}B]`,`@stats.primaryAttributes.${primaryAttributeMapping[a]}.bonus`+(t?`[${r=primaryAttributeMapping[a],r.slice(0,1).toUpperCase()+r.slice(1)} Bonus]`:""));return e}const diacriticsMap=function(){var a=[{base:"A",letters:"AⒶＡÀÁÂẦẤẪẨÃĀĂẰẮẴẲȦǠÄǞẢÅǺǍȀȂẠẬẶḀĄȺⱯ"},{base:"AA",letters:"Ꜳ"},{base:"AE",letters:"ÆǼǢ"},{base:"AO",letters:"Ꜵ"},{base:"AU",letters:"Ꜷ"},{base:"AV",letters:"ꜸꜺ"},{base:"AY",letters:"Ꜽ"},{base:"B",letters:"BⒷＢḂḄḆɃƂƁ"},{base:"C",letters:"CⒸＣĆĈĊČÇḈƇȻꜾ"},{base:"D",letters:"DⒹＤḊĎḌḐḒḎĐƋƊƉꝹÐ"},{base:"DZ",letters:"ǱǄ"},{base:"Dz",letters:"ǲǅ"},{base:"E",letters:"EⒺＥÈÉÊỀẾỄỂẼĒḔḖĔĖËẺĚȄȆẸỆȨḜĘḘḚƐƎ"},{base:"F",letters:"FⒻＦḞƑꝻ"},{base:"G",letters:"GⒼＧǴĜḠĞĠǦĢǤƓꞠꝽꝾ"},{base:"H",letters:"HⒽＨĤḢḦȞḤḨḪĦⱧⱵꞍ"},{base:"I",letters:"IⒾＩÌÍÎĨĪĬİÏḮỈǏȈȊỊĮḬƗ"},{base:"J",letters:"JⒿＪĴɈ"},{base:"K",letters:"KⓀＫḰǨḲĶḴƘⱩꝀꝂꝄꞢ"},{base:"L",letters:"LⓁＬĿĹĽḶḸĻḼḺŁȽⱢⱠꝈꝆꞀ"},{base:"LJ",letters:"Ǉ"},{base:"Lj",letters:"ǈ"},{base:"M",letters:"MⓂＭḾṀṂⱮƜ"},{base:"N",letters:"NⓃＮǸŃÑṄŇṆŅṊṈȠƝꞐꞤ"},{base:"NJ",letters:"Ǌ"},{base:"Nj",letters:"ǋ"},{base:"O",letters:"OⓄＯÒÓÔỒỐỖỔÕṌȬṎŌṐṒŎȮȰÖȪỎŐǑȌȎƠỜỚỠỞỢỌỘǪǬØǾƆƟꝊꝌ"},{base:"OI",letters:"Ƣ"},{base:"OO",letters:"Ꝏ"},{base:"OU",letters:"Ȣ"},{base:"OE",letters:"Œ"},{base:"oe",letters:"œ"},{base:"P",letters:"PⓅＰṔṖƤⱣꝐꝒꝔ"},{base:"Q",letters:"QⓆＱꝖꝘɊ"},{base:"R",letters:"RⓇＲŔṘŘȐȒṚṜŖṞɌⱤꝚꞦꞂ"},{base:"S",letters:"SⓈＳẞŚṤŜṠŠṦṢṨȘŞⱾꞨꞄ"},{base:"T",letters:"TⓉＴṪŤṬȚŢṰṮŦƬƮȾꞆ"},{base:"TZ",letters:"Ꜩ"},{base:"U",letters:"UⓊＵÙÚÛŨṸŪṺŬÜǛǗǕǙỦŮŰǓȔȖƯỪỨỮỬỰỤṲŲṶṴɄ"},{base:"V",letters:"VⓋＶṼṾƲꝞɅ"},{base:"VY",letters:"Ꝡ"},{base:"W",letters:"WⓌＷẀẂŴẆẄẈⱲ"},{base:"X",letters:"XⓍＸẊẌ"},{base:"Y",letters:"YⓎＹỲÝŶỸȲẎŸỶỴƳɎỾ"},{base:"Z",letters:"ZⓏＺŹẐŻŽẒẔƵȤⱿⱫꝢ"},{base:"a",letters:"aⓐａẚàáâầấẫẩãāăằắẵẳȧǡäǟảåǻǎȁȃạậặḁąⱥɐ"},{base:"aa",letters:"ꜳ"},{base:"ae",letters:"æǽǣ"},{base:"ao",letters:"ꜵ"},{base:"au",letters:"ꜷ"},{base:"av",letters:"ꜹꜻ"},{base:"ay",letters:"ꜽ"},{base:"b",letters:"bⓑｂḃḅḇƀƃɓ"},{base:"c",letters:"cⓒｃćĉċčçḉƈȼꜿↄ"},{base:"d",letters:"dⓓｄḋďḍḑḓḏđƌɖɗꝺ"},{base:"dz",letters:"ǳǆ"},{base:"e",letters:"eⓔｅèéêềếễểẽēḕḗĕėëẻěȅȇẹệȩḝęḙḛɇɛǝ"},{base:"f",letters:"fⓕｆḟƒꝼ"},{base:"g",letters:"gⓖｇǵĝḡğġǧģǥɠꞡᵹꝿ"},{base:"h",letters:"hⓗｈĥḣḧȟḥḩḫẖħⱨⱶɥ"},{base:"hv",letters:"ƕ"},{base:"i",letters:"iⓘｉìíîĩīĭïḯỉǐȉȋịįḭɨı"},{base:"j",letters:"jⓙｊĵǰɉ"},{base:"k",letters:"kⓚｋḱǩḳķḵƙⱪꝁꝃꝅꞣ"},{base:"l",letters:"lⓛｌŀĺľḷḹļḽḻſłƚɫⱡꝉꞁꝇ"},{base:"lj",letters:"ǉ"},{base:"m",letters:"mⓜｍḿṁṃɱɯ"},{base:"n",letters:"nⓝｎǹńñṅňṇņṋṉƞɲŉꞑꞥ"},{base:"nj",letters:"ǌ"},{base:"o",letters:"oⓞｏòóôồốỗổõṍȭṏōṑṓŏȯȱöȫỏőǒȍȏơờớỡởợọộǫǭøǿɔꝋꝍɵ"},{base:"oi",letters:"ƣ"},{base:"ou",letters:"ȣ"},{base:"oo",letters:"ꝏ"},{base:"p",letters:"pⓟｐṕṗƥᵽꝑꝓꝕ"},{base:"q",letters:"qⓠｑɋꝗꝙ"},{base:"r",letters:"rⓡｒŕṙřȑȓṛṝŗṟɍɽꝛꞧꞃ"},{base:"s",letters:"sⓢｓßśṥŝṡšṧṣṩșşȿꞩꞅẛ"},{base:"t",letters:"tⓣｔṫẗťṭțţṱṯŧƭʈⱦꞇ"},{base:"tz",letters:"ꜩ"},{base:"u",letters:"uⓤｕùúûũṹūṻŭüǜǘǖǚủůűǔȕȗưừứữửựụṳųṷṵʉ"},{base:"v",letters:"vⓥｖṽṿʋꝟʌ"},{base:"vy",letters:"ꝡ"},{base:"w",letters:"wⓦｗẁẃŵẇẅẘẉⱳ"},{base:"x",letters:"xⓧｘẋẍ"},{base:"y",letters:"yⓨｙỳýŷỹȳẏÿỷẙỵƴɏỿ"},{base:"z",letters:"zⓩｚźẑżžẓẕƶȥɀⱬꝣ"}];let r=[];for(let t=0;t<a.length;t++){var i=a[t].letters;for(let e=0;e<i.length;e++)r[i[e]]=a[t].base}return r}();function removeDiacritics(e){return e.replace(/[^\u0000-\u007E]/g,function(e){return diacriticsMap[e]||e})}function normalizeName(e){return removeDiacritics(e).toLowerCase().replaceAll(/[^a-zA-Z0-9]/g,"")}function normalizedEquals(e,t){return normalizeName(e)===normalizeName(t)}function sortByItemSpecificity({referenceNames:r=[],packPriority:i=!0}={}){const a=e=>{var t=0,a=i?4:0;return t+=e?.pack?a:4-a,t+=r.includes(e?.name)?2:0,t+=e?.isOwner?1:0};return(e,t)=>a(t)-a(e)}function partitionByNames(t){return function(e){let a;a=t?t.map(normalizeName):[...new Set(e.map(e=>normalizeName(e.name)))];const r=Array(a.length);for(let e=0;e<r.length;e++)r[e]=[];return e.forEach(e=>{var t=a.indexOf(normalizeName(e.name));r[t].push(e)}),r}}async function findItemsByType(t,{takeOne:e=!1,filterFn:a,sortFn:r=sortByItemSpecificity(),partitionFn:i=partitionByNames()}={}){const n={type:t},s=(await Promise.all(game.packs.filter(e=>"Item"===e.documentClass.documentName).map(e=>e.getDocuments(n)))).flatMap(e=>e);var o=game.collections.get("Item").filter(e=>e.type===t);let l=s.concat(o);if(a&&(l=l.filter(a)),i){const c=i(l);return r&&c.forEach(e=>e.sort(r)),e?c.map(e=>e[0]??null):c}return r&&l.sort(r),e?l[0]??null:l}async function findItemsWorldWide(e,t,a={}){const r=t.map(normalizeName);return findItemsByType(e,{...a,filterFn:e=>r.includes(normalizeName(e.name)),sortFn:sortByItemSpecificity({referenceNames:t}),partitionFn:partitionByNames(t)})}async function findItemWorldWide(e,t){return findItemsWorldWide(e,[t],{takeOne:!0}).then(e=>e[0])}class ZweihanderBaseActor{prepareEmbeddedEntities(e){}getRollData(e){return e}buildPerilDamageLadder(t,a,r){let i=0;t.stats.secondaryAttributes.perilThreshold={},t.stats.secondaryAttributes.damageThreshold={},["value","valuePlusSix","valuePlusTwelve","valuePlusEighteen"].forEach(e=>{t.stats.secondaryAttributes.perilThreshold[e]=a+i,t.stats.secondaryAttributes.damageThreshold[e]=r+i,i+=6})}getPerilMalus(e){return{0:30,1:30,2:20,3:10}[e.stats.secondaryAttributes.perilCurrent.value]??0}async createEmbeddedDocuments(e,r,t,i){if("Item"!==e)return r;{const l=[];let e=1===i.data.ancestry.length,a=i.data.professions.length;for(let t of r){var n,s,o;"profession"===t.type?(n=i.data.professions.map(e=>e.data.tier.completed).every(e=>!0===e),s=3==a,o=i.data.professions.some(e=>e._id===t._id),s&&!o?ui.notifications.error("A character may not enter more than 3 Professions."):n||o||ui.notifications.error("A character must complete the previous Tier before entering a new Profession."),!s&&n&&(l.push(t),a++)):"ancestry"===t.type?e?ui.notifications.error("A character may not possess more than 1 Ancestry."):(l.push(t),e=!0):l.push(t)}return l}}}class ZweihanderActorConfig extends FormApplication{static defaultConfiguration={dthAttribute:"brawn",pthAttribute:"willpower",intAttribute:"perception",movAttribute:"agility",perilOffset:0,encumbranceModifier:0,initiativeModifier:0,movementModifier:0,parrySkills:["Simple Melee","Martial Melee","Guile","Charm","Incantation"],dodgeSkills:["Coordination","Guile","Drive","Ride"],magickSkills:["Incantation","Folklore"]};static getValue(e,t){return getProperty(e.flags,"zweihander.actorConfig."+t)??this.defaultConfiguration[t]}static getConfig(e){const t={};for(var a in this.defaultConfiguration)t[a]=this.getValue(e,a);return t}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["zweihander sheet actor-config"],id:"zweihander_actor_config",template:"systems/zweihander/templates/actor/actor-config.hbs",width:500})}get title(){return this.object.name+": Actor Configuration"}getData(){const e=super.getData();return e.flags=ZweihanderActorConfig.getConfig(this.object.data),e.parrySkills=e.flags.parrySkills.join(", "),e.dodgeSkills=e.flags.dodgeSkills.join(", "),e}async _updateObject(e,t){const a=this.object;let r=foundry.utils.expandObject(t).flags;var i=r.parrySkills.split(",").map(e=>e.trim()),t=r.dodgeSkills.split(",").map(e=>e.trim());r.parrySkills=i,r.dodgeSkills=t,await a.setFlag("zweihander","actorConfig",r)}}class ZweihanderPC extends ZweihanderBaseActor{prepareBaseData(e,t){}prepareEmbeddedEntities(t){const a=["trapping","condition","injury","disease","disorder","profession","ancestry","armor","weapon","spell","ritual","talent","trait","drawback","quality","skill","uniqueAdvance"],r=e=>({injury:"injuries",ancestry:"ancestry",armor:"armor",quality:"qualities"})[e]??e+"s";a.forEach(e=>t[r(e)]=[]),t.items.filter(e=>a.includes(e.type)).forEach(e=>t[r(e.type)].push(e.toObject(!1))),t.skills=t.skills.sort((e,t)=>e.name.localeCompare(t.name))}prepareDerivedData(i){const n=null===i._id;var e=ZweihanderActorConfig.getConfig(i);const s=i.data;if(s.derived={},game.settings.get("zweihander","trackRewardPoints")){const b={Basic:100,Intermediate:200,Advanced:300};s.rewardPoints.spent=i.professions.map(e=>b[e.data.tier.value]*e.data.tier.advancesPurchased).concat(i.uniqueAdvances.map(e=>e.data.rewardPointCost.value)).reduce((e,t)=>e+t,0),s.rewardPoints.current=s.rewardPoints.total-s.rewardPoints.spent}s.tier=i.professions[i.professions.length-1]?.data.tier.value??"",Object.values(s.stats.primaryAttributes).forEach(e=>e.bonus=Math.floor(e.value/10));var t=i.ancestry[0];const a=(e,a,r)=>e.forEach(e=>{var t=primaryAttributeMapping[e.slice(1,2)];t?s.stats.primaryAttributes[t].bonus+=a:ui?.notifications?.warn(`"${e.trim()}" is not a valid primary attribute bonus abbreviation in ${r}!`)});t&&(a(t.data.ancestralModifiers.positive,1,`ancestry ${t.name} of actor `+i.name),a(t.data.ancestralModifiers.negative,-1,`ancestry ${t.name} of actor `+i.name)),i.professions.forEach(e=>{var t=e.data.bonusAdvances.filter(e=>e.purchased).map(e=>e.value);a(t,1,`profession ${e.name} of actor `+i.name)});const r=i.armor.filter(e=>e.data.equipped);s.derived.dtm=Math.max(0,...r.map(e=>e.data.damageThresholdModifier.value));var o=s.stats.primaryAttributes[e.pthAttribute].bonus+3,l=s.derived.dtm,c=s.stats.primaryAttributes[e.dthAttribute].bonus+l;this.buildPerilDamageLadder(s,o,c);const d=this.getPerilMalus(s);var u=(t,e)=>{const a=i.skills.find(e=>e.name===t.associatedSkill);var r;a?(r=a.data.associatedPrimaryAttribute.value.toLowerCase(),t.value=s.stats.primaryAttributes[r].value+Math.max(0,a.data.bonus-d)):n||ui?.notifications?.warn(`Can't find associated skill ${t.associatedSkill} for secondary attribute ${e}!`)};u(s.stats.secondaryAttributes.parry,"Parry"),u(s.stats.secondaryAttributes.dodge,"Dodge"),u(s.stats.secondaryAttributes.magick,"Magick");const f=i.trappings.filter(e=>e.data.carried);var p,h,t=game.settings.get("zweihander","encumbranceNineForOne")?Math.floor(f.filter(e=>0===e.data.encumbrance.value).map(e=>e.data.quantity.value).reduce((e,t)=>e+t,0)/9):0,l=f.filter(e=>0!==e.data.encumbrance.value).map(e=>e.data.encumbrance.value*e.data.quantity.value).reduce((e,t)=>e+t,0),o=Math.floor(Object.entries(s.coinage).map(e=>e[1]).reduce((e,t)=>e+t,0)/1e3),c=r.map(e=>e.data.encumbrance.value).reduce((e,t)=>e+t,0),u=i.weapons.filter(e=>e.data.equipped).map(e=>e.data.encumbrance.value).reduce((e,t)=>e+t,0);const m=s.stats.secondaryAttributes.encumbrance={};m.value=s.stats.primaryAttributes.brawn.bonus+3+e.encumbranceModifier,m.current=t+l+o+c+u,m.overage=Math.max(0,m.current-m.value);const g=s.stats.secondaryAttributes.initiative={};g.value=s.stats.primaryAttributes[e.intAttribute].bonus+3+e.initiativeModifier,g.overage=m.overage,g.current=Math.max(0,g.value-g.overage);const v=s.stats.secondaryAttributes.movement={};v.value=s.stats.primaryAttributes[e.movAttribute].bonus+3+e.movementModifier,v.overage=m.overage,v.current=Math.max(0,v.value-v.overage);for(p of i.armor)p.data.qualities.arrayOfValues=p.data.qualities.value.split(", ");for(h of i.weapons)h.data.qualities.arrayOfValues=h.data.qualities.value.split(", ")}getRollData(e){return e}async _preCreate(e,t,a,r){let i=game.packs.get("zweihander.skills"),n=await i.getDocuments();var s=getSymmetricDifference(n.map(e=>e.toObject()),e.skills);s.length&&e.update({items:s})}}class ZweihanderCreature extends ZweihanderBaseActor{prepareEmbeddedEntities(e){const t=[],a=[],r=[],i=[],n=[],s=[],o=[],l=[],c=[],d=[];for(var u of e.items.values())"weapon"===u.type?t.push(u.data):"ancestry"===u.type?a.push(u.data):"spell"===u.type?r.push(u.data):"ritual"===u.type?i.push(u.data):"skill"===u.type?n.push(u.data):"talent"===u.type?s.push(u.data):"trait"===u.type?o.push(u.data):"trapping"===u.type?l.push(u.data):"injury"===u.type?c.push(u.data):"condition"===u.type&&d.push(u.data);e.weapons=t,e.ancestry=a,e.spells=r,e.rituals=i,e.skills=n.sort((e,t)=>{e=e.name,t=t.name;return e<t?-1:t<e?1:0}),e.talents=s,e.traits=o,e.trappings=l,e.injuries=c,e.conditions=d}getRollData(e){return e}prepareDerivedData(e){const t=e.data;let a=t.stats.primaryAttributes.willpower.bonus,r=3;const i=Object.keys(t.stats.secondaryAttributes.perilThreshold);i.forEach(e=>{t.stats.secondaryAttributes.perilThreshold[e]=a+r,r+=6});let n=t.stats.primaryAttributes.brawn.bonus;var s=Object.keys(t.stats.secondaryAttributes.damageThreshold);t.stats.secondaryAttributes.damageThreshold[s[0]]=n;for(let e=1;e<s.length;e++)t.stats.secondaryAttributes.damageThreshold[s[e]]=n+=6}}class ZweihanderNPC extends ZweihanderCreature{}class ZweihanderActor extends Actor{static types={character:new ZweihanderPC,npc:new ZweihanderNPC,creature:new ZweihanderCreature};constructor(...e){super(...e)}dispatch(e,t={orElse:{value:{},async:!1},args:[]}){if(ZweihanderActor.types[this.type]){const a=ZweihanderActor.types[this.type];if(a[e]&&"function"==typeof a[e])return t?.args?.length?a[e](...t.args,this):a[e](this.data,this)}return t?.orElse?.async?Promise.resolve(t?.orElse?.value):t?.orElse?.value}prepareData(){super.prepareData()}prepareBaseData(){super.prepareBaseData(),this.dispatch("prepareBaseData")}prepareEmbeddedDocuments(){super.prepareEmbeddedDocuments&&super.prepareEmbeddedDocuments(),this.dispatch("prepareEmbeddedEntities")}prepareEmbeddedEntities(){super.prepareEmbeddedEntities&&super.prepareEmbeddedEntities(),this.dispatch("prepareEmbeddedEntities")}applyActiveEffects(){super.applyActiveEffects(),this.dispatch("applyActiveEffects")}prepareDerivedData(){super.prepareDerivedData(),this.dispatch("prepareDerivedData")}getRollData(){return this.dispatch("getRollData",{args:[this.data.data],orElse:{value:this.data.data}})}async _preCreate(e,t,a){await super._preCreate(e,t,a),await this.dispatch("_preCreate",{args:[this.data,t,a]})}async _onCreate(e,t,a){await super._onCreate(e,t,a),a===game.user.id&&await this.dispatch("_onCreate",{args:[e,t,a]})}async createEmbeddedDocuments(e,t,a={}){t=await this.dispatch("createEmbeddedDocuments",{args:[e,t,a]});if(t)return super.createEmbeddedDocuments(e,t,a)}async updateEmbeddedDocuments(e,t,a={}){t=await this.dispatch("updateEmbeddedDocuments",{args:[e,t,a],orElse:{value:t,async:!0}});if(t)return super.updateEmbeddedDocuments(e,t,a)}async deleteEmbeddedDocuments(e,t,a={}){return await this.dispatch("deleteEmbeddedDocuments",{args:[e,t,a]}),super.deleteEmbeddedDocuments(e,t,a)}_preCreateEmbeddedDocuments(e,t,a,r){super._preCreateEmbeddedDocuments(e,t,a,r),r===game.user.id&&this.dispatch("_preCreateEmbeddedDocuments",{args:[e,t,a,r]})}_onCreateEmbeddedDocuments(e,t,a,r,i){super._onCreateEmbeddedDocuments(e,t,a,r,i),i===game.user.id&&this.dispatch("_onCreateEmbeddedDocuments",{args:[e,t,a,r,i]})}_preUpdateEmbeddedDocuments(e,t,a,r){super._preUpdateEmbeddedDocuments(e,t,a,r),r===game.user.id&&this.dispatch("_preUpdateEmbeddedDocuments",{args:[e,t,a,r]})}_onUpdateEmbeddedDocuments(e,t,a,r,i){super._onUpdateEmbeddedDocuments(e,t,a,r,i),i===game.user.id&&this.dispatch("_onUpdateEmbeddedDocuments",{args:[e,t,a,r,i]})}_preDeleteEmbeddedDocuments(e,t,a,r){super._preDeleteEmbeddedDocuments(e,t,a,r),r===game.user.id&&this.dispatch("_preDeleteEmbeddedDocuments",{args:[e,t,a,r]})}_onDeleteEmbeddedDocuments(e,t,a,r,i){super._onDeleteEmbeddedDocuments(e,t,a,r,i),i===game.user.id&&this.dispatch("_onDeleteEmbeddedDocuments",{args:[e,t,a,r,i]})}}class ZweihanderDice{static async rollSkillTest(i,n,s,o={}){const l=i.data.associatedPrimaryAttribute.value,c=n.data.stats.primaryAttributes[l.toLowerCase()].value,d=i.data.bonus;var e=Number(n.data.stats.secondaryAttributes.perilCurrent.value);const u=this._calculatePerilPenalty(e,d),f=this._calculateBaseChanceModifier(d,u);var t=await this._renderConfigurationDialog(s,i.name,o),a=t.additionalChaosDice||0,r=t.additionalFuryDice||0;let p=Number(t.difficultyRating);t.channelPowerBonus&&(p+=Number(t.channelPowerBonus)),30<p&&(p=30);const h=this._getDifficultyRatingLabel(p),m=t.flip,g=this._calculateTotalChance(c,f,p);let v=new Roll(CONFIG.ZWEI.testRollFormula,n.data),b=await v.evaluate({async:!0});var y=b._total,w=this._getDeconstructedRollData(y),e=this._getTestResult(y,g,w.match);let[k,S,C]=this._handleFlippedResult(y,g,e,w,m),_,A;if("weapon"===s){o.formula=o.formula.replace("[#]",r),o.formula=abbreviations2DataPath(o.formula);let e=await this._rollFuryDice(o,n);var T=e.terms.filter(e=>0<=e?.number).map((e,t)=>({value:e,index:t})).filter(e=>e.value?.faces),I=e.result.split(" + ");let t=[];for(let e=0;e<I.length;e++)for(var E of T)E.index==e?E.value.results.map(e=>e.result+(e?.exploded?"*":"")).forEach(e=>t.push(e)):t.push(I[e]);let a;a=0===t.length?"0":t.reduce((e,t)=>e+" + "+t),_={damage:e.total,damageFormula:e.formula,furyDiceString:a,additionalRoll:e}}else"spell"===s&&Number(t.channelPowerBonus)&&(r=t.channelPowerBonus/10,a=await this._rollChaosDice(n,r+Number(a)),A={chaosFormula:a._formula,chaosDice:a.dice,channelPowerBonus:t.channelPowerBonus,additionalRoll:a});b.render().then(()=>{let e={skill:i.name,primaryAttribute:l,attributeChance:c,rankBonus:d,baseChance:c+f,totalChance:g,difficultyRating:{value:p,label:h},perilPenalty:u,roll:k.toLocaleString(void 0,{minimumIntegerDigits:2}),image:n.img,showFlip:S,flip:m,testResult:C};isObjectEmpty$1(_)?isObjectEmpty$1(A)||foundry.utils.mergeObject(e,A):foundry.utils.mergeObject(e,_),isObjectEmpty$1(o)||foundry.utils.mergeObject(e,o);var t=this._getTemplate(s);b.dice[0].options.rollOrder=1;const a=[b];e.additionalRoll&&2<=C&&(e.additionalRoll.dice[0].options.rollOrder=2,a.push(e.additionalRoll));var r=PoolTerm.fromRolls(a);v=Roll.fromTerms([r]),this._renderChatCard(t,e,v)})}static async _renderChatCard(e,t,a){renderTemplate(e,t).then(e=>{e={roll:a,type:CONST.CHAT_MESSAGE_TYPES.ROLL,user:game.user.id,speaker:ChatMessage.getSpeaker({actor:this.actor}),content:e};ChatMessage.create(e)})}static _calculatePerilPenalty(e,t){return 3===e&&10<=t||2===e&&10<=t&&t<20?10:2===e&&20<=t?20:1===e&&10<=t&&t<20?10:1===e&&20<=t&&t<30?20:1===e&&30<=t?30:0}static _calculateBaseChanceModifier(e,t){let a=e-t;return 30<a?a=30:a<-30&&(a=-30),a}static _calculateTotalChance(e,t,a){let r=e+t+a;return(100<=r?99:r<1?1:r).toLocaleString(void 0,{minimumIntegerDigits:2})}static async _rollFuryDice(e,t){let a=new Roll(e.formula,t.data);return await a.evaluate({async:!0})}static async _rollChaosDice(e,t){let a=new Roll(t+"d6",e.data);return await a.evaluate({async:!0})}static async _renderConfigurationDialog(e,t,r={}){switch(e){case"dodge":case"parry":case"skill":return new Promise(a=>{renderTemplate(CONFIG.ZWEI.templates.skillConfigurationDialog,r).then(e=>{this._createDialog(t,e,e=>{var t=e.find('[name="difficultyRatingSelect"]').val(),e=e.find('[name="flipSelect"]').val();a({difficultyRating:t,flip:e})}).render(!0)})});case"spell":return new Promise(i=>{renderTemplate(CONFIG.ZWEI.templates.spellConfigurationDialog,r).then(e=>{this._createDialog(t,e,e=>{var t=e.find('[name="extraChaos"]').val(),a=e.find('[name="difficultyRatingSelect"]').val(),r=e.find('[name="channelSelect"]').val(),e=e.find('[name="flipSelect"]').val();i({additionalChaosDice:t,difficultyRating:a,channelPowerBonus:r,flip:e})}).render(!0)})});case"weapon":return new Promise(i=>{renderTemplate(CONFIG.ZWEI.templates.weaponConfigurationDialog,r).then(e=>{this._createDialog(t,e,e=>{var t=e.find('[name="extraFury"]').val(),a=e.find('[name="difficultyRatingSelect"]').val(),r=e.find('[name="channelSelect"]').val(),e=e.find('[name="flipSelect"]').val();i({additionalFuryDice:t,difficultyRating:a,channelPowerBonus:r,flip:e})}).render(!0)})})}}static _createDialog(e,t,a){return new Dialog({title:e+": Test Configuration",content:t,buttons:{no:{icon:'<i class="fas fa-times"></i>',label:"Cancel"},yes:{icon:'<i class="fas fa-check"></i>',label:"Roll",callback:a}},default:"yes"})}static _getDifficultyRatingLabel(e){switch(e){case-30:return"Arduous -30%";case-20:return"Hard -20%";case-10:return"Challenging -10%";case 0:return"Standard +/-0%";case 10:return"Routine +10%";case 20:return"Easy +20%";case 30:return"Trivial +30%";default:return"ERROR"}}static _getTestResult(e,t,a){return 100===e?0:1===e||e<=t&&a?3:e<=t&&!a?2:t<e&&a?0:t<e&&!a?1:void 0}static _getDeconstructedRollData(e){const t=e.toLocaleString(void 0,{minimumIntegerDigits:2});var a=Number(t.charAt(t.length-1)),e=Number(t.charAt(0));return{stringifiedRollValue:t,units:a,tens:e,match:a===e}}static _getTemplate(e){switch(e){case"skill":return CONFIG.ZWEI.templates.skill;case"spell":return CONFIG.ZWEI.templates.spell;case"dodge":return CONFIG.ZWEI.templates.dodge;case"parry":return CONFIG.ZWEI.templates.parry;case"weapon":return CONFIG.ZWEI.templates.weapon}}static _handleFlippedResult(e,t,a,r,i){let n=r.stringifiedRollValue,s=!1,o=a;if(!r.match&&100!==e&&1!==e){var l=10*r.units+r.tens;switch(i){case"fail":n=2<=a?l<=t?Math.min(l,e):l:e,n!==e&&(s=!0),n>t&&e<=t&&(o=1);break;case"succeed":n=10===e?1:a<2?t<l?e:l:l<=t?Math.max(l,e):e,n!==e&&(s=!0),n<=t&&t<e&&(o=2)}}return[n,s,o]}}class ZweihanderActorSheet extends ActorSheet{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["zweihander","sheet","character"],template:"systems/zweihander/templates/pc/main.hbs",width:750,height:825,resizable:!0,tabs:[{navSelector:".sheet-navigation",contentSelector:".sheet-body",initial:"main"}],scrollY:[".save-scroll"]})}getData(){const e=super.getData();e.data.owner=this.actor.isOwner,e.data.editable=this.isEditable,e.data.rollData=this.actor.getRollData.bind(this.actor),"character"===this.actor.data.type&&(e.data.rankOptions={1:"1",2:"2",3:"3",4:"4",5:"5",6:"6",7:"7",8:"8",9:"9"},e.data.perilOptions={5:"Unhindered",4:"Imperiled",3:"Ignore 1 Skill Rank",2:"Ignore 2 Skill Ranks",1:"Ignore 3 Skill Ranks",0:"INCAPACITATED!"},e.data.damageOptions={5:"Unharmed",4:"Lightly Wounded",3:"Moderately Wounded",2:"Seriously Wounded",1:"Grievously Wounded",0:"SLAIN!"});var t=e=>e.map(e=>({...e,source:e.flags.zweihander?.source?.label??"Manual",isManualSource:!e.flags.zweihander?.source?.label})),a=(e,t)=>(e.sort||0)-(t.sort||0);e.data.skills=this.actor.data.skills,e.data.professions=this.actor.data.professions,e.data.spells=this.actor.data.spells.sort(a),e.data.weapons=this.actor.data.weapons.sort(a),e.data.armor=this.actor.data.armor.sort(a),e.data.trappings=this.actor.data.trappings.sort(a),e.data.rituals=this.actor.data.rituals.sort(a),e.data.ancestry=this.actor.data.ancestry,e.data.drawbacks=t(this.actor.data.drawbacks),e.data.injuries=this.actor.data.injuries.sort(a),e.data.diseases=this.actor.data.diseases.sort(a),e.data.disorders=this.actor.data.disorders.sort(a),e.data.conditions=this.actor.data.conditions.sort(a),e.data.uniqueAdvances=this.actor.data.uniqueAdvances.sort(a),e.data.bio=this.actor.data.data.flavor.description,e.data.traits=t(this.actor.data.traits.sort(a));const r=this.actor.data.professions.flatMap(e=>e.data.talents.filter(e=>e.purchased&&e.linkedId).map(e=>this.actor.items.get(e.linkedId)?.toObject(!1)));e.data.talents=t(r.sort(a));a=ZweihanderActorConfig.getConfig(this.actor.data);return e.data.damageThresholdAttribute=a.dthAttribute,e.data.perilThresholdAttribute=a.pthAttribute,e.data.initiativeAttribute=a.intAttribute,e.data.movementAttribute=a.movAttribute,e.data.parrySkills=a.parrySkills,e.data.dodgeSkills=a.dodgeSkills,e.data.magickSkills=a.magickSkills,e.data}activateListeners(e){super.activateListeners(e),game.settings.get("zweihander","trackRewardPoints");let i=this.actor.data;this.options.editable&&(e.find(".item-edit").click(e=>{const t=$(e.currentTarget).parents(".item"),a=this.actor.items.get(t.data("itemId"));a.sheet.render(!0)}),e.find(".item-delete").click(async e=>{const t=$(e.currentTarget).parents(".item"),a=this.actor.items.get(t.data("itemId"));await Dialog.confirm({title:"Delete Embedded Item: "+a.name,content:"<p>Are you sure?</p><p>This item will be permanently deleted and cannot be recovered.</p>",yes:async()=>{await this.actor.deleteEmbeddedDocuments("Item",[a.id]),t.slideUp(200,()=>this.render(!1))},no:()=>{},defaultYes:!0})}),e.find(".skill").hover(async e=>{e="li.pa.pa-"+e.currentTarget.attributes["data-associated-pa"].value.toLowerCase();$(e).addClass("pa-hover-helper")},async e=>{e="li.pa.pa-"+e.currentTarget.attributes["data-associated-pa"].value.toLowerCase();$(e).removeClass("pa-hover-helper")}),e.find(".add-new").click(async e=>{e=e.currentTarget.dataset.itemType;const t=await this.actor.createEmbeddedDocuments("Item",[{type:e,name:e}]);t.length&&t[0].sheet.render(!0)}),e.find(".ancestry-edit-button").click(()=>{var e=this.actor.data.ancestry[0]._id;const t=this.actor.items.get(e);t.sheet.render(!0);try{t.sheet.bringToTop()}catch(e){}}),e.find(".ancestry-delete-button").click(async e=>{var t=this.actor.data.ancestry[0]._id;await this.actor.deleteEmbeddedDocuments("Item",[t])}),e.find(".fetch-property").each(async function(){var e=$(this).text().trim();let t=abbreviations2DataPath(e,!1);t=t.replaceAll(/(@[a-zA-Z0-9\.]*[a-zA-Z0-9]+)/g,e=>{e="data."+e.slice(1);return getProperty(i,e)}),e!==t&&(t=t.replaceAll(/[0-9]+(\s*[\+\-\*/]\s*[0-9]+)*/g,e=>{return new Roll(e).evaluate({async:!1}).total}),$(this).text(t))}),e.find(".link-checkbox").click(async e=>{e.preventDefault();const t=$(e.currentTarget).closest(".item"),a=this.actor.items.get(t.data("itemId"));"armor"===a.type?await a.update({"data.equipped":e.target.checked}):"profession"===a.type?await a.update({"data.tier.completed":e.target.checked}):"trapping"===a.type?await a.update({"data.carried":e.target.checked}):"weapon"===a.type?await a.update({"data.equipped":e.target.checked}):"condition"!==a.type&&"injury"!==a.type&&"disease"!==a.type&&"disorder"!==a.type||await a.update({"data.active":e.target.checked})}),this._updateDamageThresholdLabel(e),e.find(".fetch-item").contextmenu(e=>{const t=$(e.currentTarget),a=t.text().trim();e=i.items.find(e=>e.name===a).id;if(e){const r=this.actor.items.get(e);r.sheet.render(!0)}}),e.find(".item-post").click(async t=>{const e=$(t.currentTarget).parents(".item");t=this.actor.items.get(e.data("itemId"));let a;try{a=await renderTemplate(`systems/zweihander/templates/chat/chat-item-${t.type}.hbs`,t)}catch(e){a=await renderTemplate("systems/zweihander/templates/chat/chat-item-fallback.hbs",t)}await ChatMessage.create({content:a})}),e.find(".purchase-link").click(e=>{const t=$(e.currentTarget);var a=t.data("purchaseType");const r=t.data("purchaseIndex");var e=t.closest(".individual-description").parents(".item");const i=this.actor.items.get($(e).data("itemId"));i.data.data.tier.completed&&this.actor.data.data.tier!==i.data.data.tier.value?ui.notifications.error(`Cannot perform operation: ${i.data.data.tier.value} Tier locked.`):(e=i.data.data[a].map((e,t)=>t===r?{...e,purchased:!e.purchased}:e),i.update({["data."+a]:e}))}),e.find(".reset-ranks").click(()=>{this.actor.update({"data.chaosRanks.value":"0","data.orderRanks.value":"0"})}),this._updateEncumbranceMeter(e),this._damageSheet(e),this._perilSheet(e),e.find(".js-show-item-description").click(e=>this._showItemDescription(e)),e.find(".skill-roll").click(e=>{this._onRollSkill(e,CONFIG.ZWEI.rollTypes.skill)}),e.find(".weapon-roll").click(e=>{this._onRollSkill(e,CONFIG.ZWEI.rollTypes.weapon)}),e.find(".spell-roll").click(e=>{this._onRollSkill(e,CONFIG.ZWEI.rollTypes.spell)}),e.find(".dodge-roll").click(e=>{this._onRollSkill(e,CONFIG.ZWEI.rollTypes.dodge)}),e.find(".parry-roll").click(e=>{this._onRollSkill(e,CONFIG.ZWEI.rollTypes.parry)}),e.find(".js-display-quality").contextmenu(async e=>{e.preventDefault();const t=$(e.currentTarget);const a=await findItemWorldWide("quality",t.text());a.sheet.render(!0)}))}_damageSheet(e){Number(this.actor.data.data.stats.secondaryAttributes.damageCurrent.value)<5&&e.find(".bloodstain-1").toggleClass("bloodstain-inactive"),Number(this.actor.data.data.stats.secondaryAttributes.damageCurrent.value)<4&&e.find(".bloodstain-2").toggleClass("bloodstain-inactive"),Number(this.actor.data.data.stats.secondaryAttributes.damageCurrent.value)<3&&e.find(".bloodstain-3").toggleClass("bloodstain-inactive"),Number(this.actor.data.data.stats.secondaryAttributes.damageCurrent.value)<2&&e.find(".bloodstain-4").toggleClass("bloodstain-inactive"),Number(this.actor.data.data.stats.secondaryAttributes.damageCurrent.value)<1&&e.find(".bloodstain-5").toggleClass("bloodstain-inactive")}_perilSheet(e){Number(this.actor.data.data.stats.secondaryAttributes.perilCurrent.value)<5&&e.find(".profile-image").addClass("peril1"),Number(this.actor.data.data.stats.secondaryAttributes.perilCurrent.value)<4&&e.find(".profile-image").addClass("peril2"),Number(this.actor.data.data.stats.secondaryAttributes.perilCurrent.value)<3&&e.find(".profile-image").addClass("peril3"),Number(this.actor.data.data.stats.secondaryAttributes.perilCurrent.value)<2&&e.find(".profile-image").addClass("peril4"),Number(this.actor.data.data.stats.secondaryAttributes.perilCurrent.value)<1&&e.find(".profile-image").addClass("peril5")}async _onRollSkill(e,t){e.preventDefault();var a=e.currentTarget;const r=a.dataset,i=this.actor.data,n=r.label.toLowerCase();var s=i.skills[i.skills.findIndex(e=>e.name.toLowerCase()===n)];if(s)switch(t){case CONFIG.ZWEI.rollTypes.dodge:case CONFIG.ZWEI.rollTypes.parry:case CONFIG.ZWEI.rollTypes.skill:await ZweihanderDice.rollSkillTest(s,i,t);break;case CONFIG.ZWEI.rollTypes.weapon:var o=$(a).parents(".item")[0].dataset.itemId,o=i.items.get(o);o&&(l={weaponQualities:(l=o.data).data.qualities.arrayOfValues,weaponName:l.name,formula:l.data.damage.formula,bonus:{value:l.data.damage.primaryAttributeBonus,label:l.data.damage.associatedPrimaryAttribute}},await ZweihanderDice.rollSkillTest(s,i,t,l));break;case CONFIG.ZWEI.rollTypes.spell:var l=$(a).parents(".item")[0].dataset.itemId,l=i.items.get(l);l&&(l={spellName:(l=l.data).name,principle:l.data.principle.value,duration:this._formatDuration(l.data.duration.value,i),distance:l.data.distance.value,flavor:l.data.flavor.description,effect:l.data.effect,reagents:l.data.reagents.value,tradition:l.data.tradition.value},await ZweihanderDice.rollSkillTest(s,i,t,l))}else ui.notifications.error(`Associated Skill "${r.label}" does not exist for this actor!`)}_formatDuration(e,t){if("@"===e[0]){const a=e.split("+");e=a[0].replace("@","data."),t=getProperty(t,e),e=a[1].split(" ");return t+Number(e[0])+" "+e[1]}}_showItemDescription(e){e.preventDefault();const t=$(e.currentTarget),a=t.parents(".item");e=a.find(".item-summary");$(e).slideToggle(function(){$(this).toggleClass("open")})}_updateDamageThresholdLabel(e){const t=e.find(".label.dtm").text();var a=t.split("+"),r=this.actor.items.find(e=>"armor"===e.type&&1==e.data.data.equipped);null!=r&&(r=r.data.data.damageThresholdModifier.value,e.find(".label.dtm").text(a[0]+"+"+r))}_updateEncumbranceMeter(e){var t=this.actor.data.data.stats.secondaryAttributes.encumbrance;let a=t.current/t.value*100;100<a&&(a=100,e.find(".encumbrance-bar-container").addClass("encumbrance-overage")),e.find(".encumbrance-bar").css("width",a+"%")}async _render(e=!1,t={}){var a=["professions","drawbacks","weapons","armor","trappings","talents-and-traits","unique-advances","spells","rituals","conditions","injuries","diseases","disorders"];this._saveToggleStates(a),await super._render(e,t),this._setToggleStates(a)}_saveToggleStates(e){if(null!==this.form){const n=$(this.form).parent();this.toggleStates={};for(var t of e){var a,r=$(n.find(".save-toggle-"+t));this.toggleStates[t]=[];for(a of r){var i=$(a).hasClass("open");this.toggleStates[t].push(i)}}}}_setToggleStates(e){if(this.toggleStates){const r=$(this.form).parent();for(var t of e)if(this.toggleStates[t].length){var a=$(r.find(".save-toggle-"+t));for(let e=0;e<a.length;e++)this.toggleStates[t][e]&&$(a[e]).show().addClass("open")}}}}class ZweihanderNpcSheet extends ActorSheet{static get defaultOptions(){return mergeObject(super.defaultOptions,{classes:["zweihander","sheet","npc"],template:"systems/zweihander/templates/actor/npc-sheet.hbs",width:689,height:890,resizable:!1,tabs:[],scrollY:[]})}getData(){const e=super.getData();return e.dtypes=["String","Number","Boolean"],e.data.skills=this.actor.data.skills,e.data.spells=this.actor.data.spells,e.data.weapons=this.actor.data.weapons,e.data.trappings=this.actor.data.trappings,e.data.talents=this.actor.data.talents,e.data.traits=this.actor.data.traits,e.data.rituals=this.actor.data.rituals,e.data.ancestry=this.actor.data.ancestry,e.data.injuries=this.actor.data.injuries,e.data.conditions=this.actor.data.conditions,e.data}activateListeners(e){super.activateListeners(e),this.actor.data,this.options.editable&&(e.find(".add-new").click(async e=>{e=e.currentTarget.dataset.itemType;if("talentTrait"!==e){const t=await this.actor.createEmbeddedDocuments("Item",[{type:e,name:e}]);t[0].sheet.render(!0)}}),e.find(".ancestry-edit-button").click(e=>{var t=this.actor.data.ancestry[0]._id;const a=this.actor.items.get(t);a.sheet.render(!0)}),e.find(".ancestry-delete-button").click(async e=>{var t=this.actor.data.ancestry[0]._id;await this.actor.deleteEmbeddedDocuments("Item",[t])}),e.find(".fetch-skill").contextmenu(e=>{const t=$(e.currentTarget),a=t.text().trim().split("+")[0];e=this.actor.data.skills.find(e=>e.name===a)._id;if(e){const r=this.actor.items.get(e);r.sheet.render(!0)}}),e.find(".item-edit").click(e=>{const t=$(e.currentTarget).parents(".item"),a=this.actor.items.get(t.data("itemId"));a.sheet.render(!0)}),e.find(".item-delete").click(async e=>{const t=$(e.currentTarget).parents(".item");e=t.children(".image-and-name").children("span").text();await Dialog.confirm({title:"Delete Embedded Item: "+e,content:"<p>Are you sure?</p><p>This item will be permanently deleted and cannot be recovered.</p>",yes:async()=>{await this.actor.deleteEmbeddedDocuments("Item",[t.data("itemId")]),t.slideUp(200,()=>this.render(!1))},no:()=>{},defaultYes:!1})}),this._setThresholds(e),this._alternateRowColor(e))}_setThresholds(e){var t=Object.keys(this.actor.data.data.stats.secondaryAttributes.perilThreshold),a=Object.keys(this.actor.data.data.stats.secondaryAttributes.damageThreshold);let r="";for(let e=1;e<t.length;e++)r+=""+this.actor.data.data.stats.secondaryAttributes.perilThreshold[t[e]],e!==t.length-1&&(r+="/");let i="";for(let e=1;e<a.length;e++)i+=""+this.actor.data.data.stats.secondaryAttributes.damageThreshold[a[e]],e!==a.length-1&&(i+="/");e.find(".derived.peril").text(r),e.find(".derived.damage").text(i)}_alternateRowColor(e){e.find(".even").css("background","var(--zh-clr-bright1)")}async _updateObject(e,t){return this.object.update(t)}}class ZweihanderCreatureSheet extends ActorSheet{static get defaultOptions(){return mergeObject(super.defaultOptions,{classes:["zweihander","sheet","npc"],template:"systems/zweihander/templates/actor/npc-sheet.hbs",width:689,height:890,resizable:!1,tabs:[],scrollY:[]})}getData(){const e=super.getData();return e.dtypes=["String","Number","Boolean"],e.data.skills=this.actor.data.skills,e.data.spells=this.actor.data.spells,e.data.weapons=this.actor.data.weapons,e.data.trappings=this.actor.data.trappings,e.data.talents=this.actor.data.talents,e.data.traits=this.actor.data.traits,e.data.rituals=this.actor.data.rituals,e.data.ancestry=this.actor.data.ancestry,e.data.injuries=this.actor.data.injuries,e.data.conditions=this.actor.data.conditions,e.data}activateListeners(e){super.activateListeners(e),this.actor.data,this.options.editable&&(e.find(".add-new").click(async e=>{e=e.currentTarget.dataset.itemType;if("talentTrait"!==e){const t=await this.actor.createEmbeddedDocuments("Item",[{type:e,name:e}]);t[0].sheet.render(!0)}}),e.find(".ancestry-edit-button").click(e=>{var t=this.actor.data.ancestry[0]._id;const a=this.actor.items.get(t);a.sheet.render(!0)}),e.find(".ancestry-delete-button").click(async e=>{var t=this.actor.data.ancestry[0]._id;await this.actor.deleteEmbeddedDocuments("Item",[t])}),e.find(".fetch-skill").contextmenu(e=>{const t=$(e.currentTarget),a=t.text().trim().split("+")[0];e=this.actor.data.skills.find(e=>e.name===a)._id;if(e){const r=this.actor.items.get(e);r.sheet.render(!0)}}),e.find(".item-edit").click(e=>{const t=$(e.currentTarget).parents(".item"),a=this.actor.items.get(t.data("itemId"));a.sheet.render(!0)}),e.find(".item-delete").click(async e=>{const t=$(e.currentTarget).parents(".item");e=t.children(".image-and-name").children("span").text();await Dialog.confirm({title:"Delete Embedded Item: "+e,content:"<p>Are you sure?</p><p>This item will be permanently deleted and cannot be recovered.</p>",yes:async()=>{await this.actor.deleteEmbeddedDocuments("Item",[t.data("itemId")]),t.slideUp(200,()=>this.render(!1))},no:()=>{},defaultYes:!1})}),this._setThresholds(e),this._alternateRowColor(e))}_setThresholds(e){var t=Object.keys(this.actor.data.data.stats.secondaryAttributes.perilThreshold),a=Object.keys(this.actor.data.data.stats.secondaryAttributes.damageThreshold);let r="";for(let e=1;e<t.length;e++)r+=""+this.actor.data.data.stats.secondaryAttributes.perilThreshold[t[e]],e!==t.length-1&&(r+="/");let i="";for(let e=1;e<a.length;e++)i+=""+this.actor.data.data.stats.secondaryAttributes.damageThreshold[a[e]],e!==a.length-1&&(i+="/");e.find(".derived.peril").text(r),e.find(".derived.damage").text(i)}_alternateRowColor(e){e.find(".even").css("background","var(--zh-clr-bright1)")}async _updateObject(e,t){return this.object.update(t)}}class ZweihanderBaseItem{static async _getOrCreateLinkedItem(e,t,a,r,i){let n=await findItemWorldWide(a,t);const s=e.data.items.find(e=>e.type===a&&e.name===n?.name);if(n||s){r={value:i,label:`${r} (${i.capitalize()})`};if(!s)return n=n.toObject(),setProperty(n,"flags.zweihander.source",r),{kind:"create",object:n,name:n.name};i=s.getFlag("zweihander","source");if(!i)return await s.setFlag("zweihander","source",r),{kind:"existing",id:s.id,name:s.name};ui?.notifications.warn(`The ${s.type.capitalize()} "${s.name}" has been previously added by ${i.label}! Please contact your GM to replace this ${s.type} on `+r.label)}}static async getOrCreateLinkedItem(e,t,a,r,i){var{kind:n,object:a,id:r,name:i}=await this._getOrCreateLinkedItem(e,t,a,r,i)??{};let s=null;return"existing"===n?s=r:"create"===n&&(s=await e.createEmbeddedDocuments("Item",[a]).then(e=>e[0].id)),{linkedId:s,value:i??t}}static async getOrCreateLinkedItems(e,t,a,r,i){const n=[],s={};for(var o of t){var l=normalizeName(o),{kind:c,object:d,id:u,name:f}=await this._getOrCreateLinkedItem(e,o,a,r,i)??{};"existing"===c?s[l]={linkedId:u,value:f}:"create"===c?n.push(d):s[l]={linkedId:null,value:o}}return n.length&&await e.createEmbeddedDocuments("Item",n).then(e=>e.forEach(e=>s[normalizeName(e.name)]={linkedId:e.id,value:e.name})),t.map(e=>s[normalizeName(e)])}static async removeLinkedItem(e,t){t&&await e.deleteEmbeddedDocuments("Item",[t])}static async removeLinkedItems(e,t){t=t?.filter(e=>e);t.length&&await e.deleteEmbeddedDocuments("Item",t)}static async updateLinkedItemIds(e,t){let a=0;const r=[];for(item of e)normalizedEquals(t[a].name,item.value)?(item.value=t[a].name,item.linkedId=t[a].id,a++):item.linkedId=null,r.push(item);return r}static getLinkedItemsDifference(e,t){var a=(e,a)=>e.filter(t=>!a.some(e=>t.value===e.value));return{namesToAdd:a(e,t).map(e=>e.value),idsToDelete:a(t,e).map(e=>e.linkedId)}}getRollData(e){return e}}class ZweihanderWeapon extends ZweihanderBaseItem{}class ZweihanderProfession extends ZweihanderBaseItem{prepareDerivedData(e,t){t.isOwned&&(t=1+e.data.bonusAdvances.reduce((e,t)=>e+Number(t.purchased),0)+e.data.skillRanks.reduce((e,t)=>e+Number(t.purchased),0)+e.data.talents.reduce((e,t)=>e+Number(t.purchased),0),e.data.tier.advancesPurchased=t,e.data.tier.completed=21===t)}async _preCreate(e,t,a,r){const i=r.data;var n=r.parent.data.professions.length;if(!(3<n)){i.update({"data.tier.value":["Basic","Intermediate","Advanced"][n]}),i.update({"data.skillRanks":i.data.skillRanks.map(e=>({...e,purchased:!1}))}),i.update({"data.bonusAdvances":i.data.bonusAdvances.map(e=>({...e,purchased:!1}))});var s=i.data.talents.map(e=>e.value);if(s.length){const o=await ZweihanderBaseItem.getOrCreateLinkedItems(r.parent,s,"talent",r.name,"profession");i.update({"data.talents":o.map(e=>({...e,purchased:!1}))})}n=i.data.professionalTrait.value.trim(),s=i.data.specialTrait.value.trim(),s=await ZweihanderBaseItem.getOrCreateLinkedItems(r.parent,[n,s],"trait",r.name,"profession");i.update({"data.professionalTrait":s[0],"data.specialTrait":s[1]});s=i.data.drawback.value,r=await ZweihanderBaseItem.getOrCreateLinkedItem(r.parent,s,"drawback",r.name,"profession");i.update({"data.drawback":r})}}async _preUpdate(e,t,a,r){var i=r.parent,n=r.data;const s=e.data;var o,l=flattenObject(e.data);const c=[];if(void 0!==l.skillRanks&&(s.skillRanks=s.skillRanks.map(e=>({...e,purchased:e.purchased??!1}))),void 0!==l.bonusAdvances&&(s.bonusAdvances=s.bonusAdvances.map(e=>({...e,purchased:e.purchased??!1}))),void 0!==l.talents){e=ZweihanderBaseItem.getLinkedItemsDifference(s.talents,n.data.talents);c.push(...e.idsToDelete);const d=await ZweihanderBaseItem.getOrCreateLinkedItems(r.parent,e.namesToAdd,"talent",r.name,"profession"),u=d.reduce((e,t)=>({...e,[t.value]:{...t,purchased:!1}}),{});s.talents=s.talents.map(e=>u[e.value]||e)}void 0===l["professionalTrait.value"]||(r=s.professionalTrait.value.trim())!==n.data.professionalTrait.value&&(c.push(n.data.professionalTrait.linkedId),(o=await ZweihanderBaseItem.getOrCreateLinkedItem(i,r,"trait",n.name,"ancestry"))&&(s.professionalTrait=o)),void 0===l["specialTrait.value"]||(o=s.specialTrait.value.trim())!==n.data.specialTrait.value&&(c.push(n.data.specialTrait.linkedId),(o=await ZweihanderBaseItem.getOrCreateLinkedItem(i,o,"trait",n.name,"ancestry"))&&(s.specialTrait=o)),void 0===l["drawback.value"]||(l=s.drawback.value.trim())!==n.data.drawback.value&&(c.push(n.data.drawback.linkedId),(n=await ZweihanderBaseItem.getOrCreateLinkedItem(i,l,"drawback",n.name,"ancestry"))&&(s.drawback=n)),t.idsToDelete=c}async _onUpdate(e,t,a,r){t.idsToDelete.length&&await ZweihanderBaseItem.removeLinkedItems(r.parent,t.idsToDelete)}async _preDelete(e,t,a){e.idsToDelete=[a.data.data.specialTrait,a.data.data.professionalTrait,a.data.data.drawback,...a.data.data.talents].map(e=>e.linkedId)}async _onDelete(e,t,a){await ZweihanderBaseItem.removeLinkedItems(a.parent,e.idsToDelete)}}class ZweihanderSkill extends ZweihanderBaseItem{prepareBaseData(e,t){if(t.isOwned&&t?.actor?.data){const a=e.data,r=t.actor;e=r.items.filter(e=>"profession"===e.type).flatMap(e=>e.data.data.skillRanks.filter(e=>e.value===t.name&&e.purchased)).length;a.rank=e,a.bonus=10*e}}}class ZweihanderAncestry extends ZweihanderBaseItem{async _preCreate(e,t,a,r){var i=await ZweihanderBaseItem.getOrCreateLinkedItem(r.parent,r.data.data.ancestralTrait.value,"trait",r.name,"ancestry");i&&r.data.update({"data.ancestralTrait":i})}async _preUpdate(e,t,a,r){var i=r.data;const n=e.data;var s,o,l=r.parent;for(s of Object.keys(n))"ancestralTrait"!==s||(o=n.ancestralTrait.value.trim())!==i.data.ancestralTrait.value&&(await ZweihanderBaseItem.removeLinkedItem(r.parent,i.data.ancestralTrait.linkedId),(o=await ZweihanderBaseItem.getOrCreateLinkedItem(l,o,"trait",i.name,"ancestry"))&&(n.ancestralTrait=o))}async _preDelete(e,t,a){e.idToDelete=a.data.data.ancestralTrait.linkedId}async _onDelete(e,t,a){await ZweihanderBaseItem.removeLinkedItem(a.parent,e.idToDelete)}}class ZweihanderItem extends Item{static types={weapon:new ZweihanderWeapon,profession:new ZweihanderProfession,skill:new ZweihanderSkill,ancestry:new ZweihanderAncestry};constructor(...e){super(...e)}dispatch(e,t={orElse:{value:{},async:!1},args:[]}){if(ZweihanderItem.types[this.type]){const a=ZweihanderItem.types[this.type];if(a[e]&&"function"==typeof a[e])return t.args?.length?a[e](...t.args,this):a[e](this.data,this)}return t?.orElse?.async?Promise.resolve(t?.orElse?.value):t?.orElse?.value}prepareData(){super.prepareData()}prepareBaseData(){super.prepareBaseData(),this.dispatch("prepareBaseData")}prepareEmbeddedDocuments(){super.prepareEmbeddedDocuments&&super.prepareEmbeddedDocuments(),this.dispatch("prepareEmbeddedEntities")}prepareEmbeddedEntities(){super.prepareEmbeddedEntities&&super.prepareEmbeddedEntities(),this.dispatch("prepareEmbeddedEntities")}applyActiveEffects(){super.applyActiveEffects(),this.dispatch("applyActiveEffects")}prepareDerivedData(){super.prepareDerivedData(),this.dispatch("prepareDerivedData")}async _preCreate(e,t,a){await super._preCreate(e,t,a),null!==this.parent&&await this.dispatch("_preCreate",{args:[e,t,a]})}async _preDelete(e,t){await super._preDelete(e,t),null!==this.parent&&await this.dispatch("_preDelete",{args:[e,t]})}async _onDelete(e,t){await super._preDelete(e,t),t===game.user.id&&null!==this.parent&&await this.dispatch("_onDelete",{args:[e,t]})}async _preUpdate(e,t,a){this.parent&&e.data&&await this.dispatch("_preUpdate",{args:[e,t,a]}),await super._preUpdate(e,t,a)}async _onUpdate(e,t,a){await super._onUpdate(e,t,a),a===game.user.id&&null!==this.parent&&e.data&&await this.dispatch("_onUpdate",{args:[e,t,a]})}}class ZweihanderItemSheet extends ItemSheet{static get defaultOptions(){return mergeObject(super.defaultOptions,{classes:["zweihander","sheet","item"],template:"systems/zweihander/templates/item/main.hbs",width:400,height:550,resizable:!0,tabs:[{navSelector:".sheet-navigation",contentSelector:".sheet-body",initial:"details"}],dragDrop:[{dragSelector:".item-sheet-draggable",dropSelector:null}]})}_canDragStart(e){return!0}_canDragDrop(e){return this.isEditable}_onDragDrop(e){}_onDragStart(e){var t=this.item.actor,t={type:"Item",data:this.item.data,actorId:t?.id??null,ceneId:t?.isToken?canvas.scene?.id:null,tokenId:t?.isToken?t.token.id:null};e.dataTransfer.setData("text/plain",JSON.stringify(t))}async getData(){const e=super.getData();return e.data.owner=this.item.isOwner,e.data.editable=this.isEditable,e.data.rollData=this.item.getRollData.bind(this.item),"weapon"===this.item.type&&(e.data.skills=(await findItemsByType("skill",{takeOne:!0})).map(e=>e.name).sort((e,t)=>e.localeCompare(t))),e.data}activateListeners(e){super.activateListeners(e);let t=this.object.data,a=new FilePicker({type:"image",current:t.img,displayMode:"thumbs",callback:e=>{t.document.update({img:e}),this.render(!0)}});e.find(".open-editor").click(async e=>{e.preventDefault();const t=$(e.currentTarget),a=t.parents(".form-group");var r=a.find(".editor"),e=a.find(".zh-editor-preview");$(e).toggleClass("open"),$(r).toggleClass("open")}),e.find(".profile").click(async e=>{a.render(!0)}),e.find(".array-input input").keypress(async e=>13===e.which?this.acceptArrayInput(e):0),e.find(".array-input input").focusout(async e=>this.acceptArrayInput(e)),e.find(".array-input-plus").click(async e=>this.acceptArrayInput(e)),e.find(".array-input-pill").click(async e=>this.removeArrayInput(e))}async _updateObject(e,t){if("ancestry"===this.item.type){const r=t["data.ancestralTrait.value"];var a=await findItemWorldWide("trait",r);a&&(t["data.ancestralTrait.value"]=a.name),a||""===r.trim()||(ui?.notifications.warn(`Couldn't find an ancestral trait with a name like ${r} anywhere in the world or in compendia!`,{permanent:!0}),this.item.isOwned&&ui?.notifications.error("Please choose a valid, existing ancestral trait!",{permanent:!0}))}else if("profession"===this.item.type){const i=t["data.professionalTrait.value"];let e;e=await findItemWorldWide("trait",i),e&&(t["data.professionalTrait.value"]=e.name),e||""===i.trim()||(ui?.notifications.warn(`Couldn't find a professional trait with a name like ${i} anywhere in the world or in compendia!`,{permanent:!0}),this.item.isOwned&&ui?.notifications.error("Please choose a valid, existing professional trait!",{permanent:!0}));const n=t["data.specialTrait.value"];e=await findItemWorldWide("trait",n),e&&(t["data.specialTrait.value"]=e.name),e||""===n.trim()||(ui?.notifications.warn(`Couldn't find a special trait with a name like ${n} anywhere in the world or in compendia!`,{permanent:!0}),this.item.isOwned&&ui?.notifications.error("Please choose a valid, existing special trait!",{permanent:!0}));const s=t["data.drawback.value"];e=await findItemWorldWide("drawback",s),e&&(t["data.drawback.value"]=e.name),e||""===s.trim()||(ui?.notifications.warn(`Couldn't find a drawback with a name like ${s} anywhere in the world or in compendia!`,{permanent:!0}),this.item.isOwned&&ui?.notifications.error("Please choose a valid, existing drawback!",{permanent:!0}))}super._updateObject(e,t)}async acceptArrayInput(e,t=!0){t&&e.preventDefault();var a=e.currentTarget;const r=$(a).parent(".array-input");t=r.data("arrayInputTarget");const i=r.find("input").val();let n=getProperty(this.item.toObject(!1),t);e=r.data("arrayInputMax")??Number.MAX_SAFE_INTEGER;if(i?.trim()){const s=i.split(",").map(e=>e.trim()).filter(e=>""!==e);if(n.length+s.length>e){a=r.parents(".form-group").find("label").text();ui?.notifications.warn(`You can't add more than ${e} entries in "${a}"!`);e=e-n.length;if(s.splice(e,s.length-e),0===s.length)return}switch(t){case"data.ancestralModifiers.negative":case"data.ancestralModifiers.positive":n=n.concat(await this.addInputToArray(s,async e=>this.validateBonusAbbr(e),!1));break;case"data.bonusAdvances":n=n.concat(await this.addInputToArray(s,async e=>{e=await this.validateBonusAbbr(e);return e&&{value:e}},!1));break;case"data.talents":n=n.concat(await this.addInputToArray(s,async e=>this.validateTalent(e)));break;case"data.skillRanks":n=n.concat(await this.addInputToArray(s,async e=>this.validateSkillRank(e)))}await this.item.update({[t]:n}).then(()=>this.render(!1))}}async addInputToArray(e,t,a=!0){const r=[];for(var i of e=a?[...new Set(e)]:e){i=await t(i);i&&r.push(i)}return r}async removeArrayInput(e){e.preventDefault();var t=e.currentTarget;const a=$(t).parents(".array-input");e=a.data("arrayInputTarget");const r=getProperty(this.item.toObject(!1),e);t=$(t).data("arrayInputIndex");r.splice(t,1),this.item.update({[e]:r}).then(()=>this.render(!1))}async validateBonusAbbr(e){const t=["[CB]","[BB]","[AB]","[PB]","[IB]","[WB]","[FB]"];e=`[${e.trim().replaceAll(/[^a-zA-Z]/g,"").toUpperCase()}]`;if(t.includes(e))return e;ui?.notifications.warn(`"${e}" is not a valid Bonus Abbreviation! Valid values: `+t)}async validateTalent(t){const e=this.item;if(!e.data.data?.talents?.some(e=>normalizedEquals(e.value,t))){var a=await findItemWorldWide("talent",t);return a?{value:a.name}:(ui?.notifications.warn(`Couldn't find Talent with a name like ${t} anywhere in the world or in compendia!`,{permanent:!0}),this.item.isOwned&&ui?.notifications.error("Please choose a valid, existing talent!",{permanent:!0}),{value:t})}ui?.notifications.warn(`A Talent named "${t}" already belongs to item "${e.name}" of type "${e.type}". Skill Ranks must be unique!`)}async validateSkillRank(t){const e=this.item;if(!e.data.data?.skillRanks?.some(e=>normalizedEquals(e.value,t))){var a=await findItemWorldWide("skill",t);return a?{value:a.name}:(ui?.notifications.warn(`Couldn't find Skill Rank with a name like ${t} anywhere in the world or in compendia!`,{permanent:!0}),this.item.isOwned&&ui?.notifications.error("Please choose a valid, existing skill!",{permanent:!0}),{value:t})}ui?.notifications.warn(`A Skill Rank in "${t}" already belongs to item "${e.name}" of type "${e.type}". Skill Ranks must be unique!`)}}class FortuneTracker extends Application{static get PARAMS(){switch(game.settings.get("zweihander","fortuneTrackerSize")){case"compact":return{compact:!0,tokenSize:25,padding:0,areaSize:60};case"normal":return{tokenSize:64,padding:5,areaSize:120};case"big":return{tokenSize:83,padding:10,areaSize:180};case"huge":return{tokenSize:125,padding:15,areaSize:300}}}static registerPersistingSettings(){game.settings.register("zweihander","fortuneTrackerPersistedStateTotal",{name:"fortuneTrackerPersistedStateTotal",hint:"",scope:"world",type:Number,default:0,config:!1}),game.settings.register("zweihander","fortuneTrackerPersistedStateUsed",{name:"fortuneTrackerPersistedStateUsed",hint:"",scope:"world",type:Number,default:0,config:!1}),game.settings.register("zweihander","fortuneTrackerPersistedStateRemoved",{name:"fortuneTrackerPersistedStateRemoved",hint:"",scope:"world",type:Number,default:0,config:!1}),game.settings.register("zweihander","fortuneTrackerRuleSystem",{name:"Fortune Tracker Rule System",hint:"Choose how you wish to implement fortune points and misfortune points in your game.",scope:"world",type:String,choices:{remove:"Using misfortune points removes them from the game",keep:"Using misfortune points returns them to the party as fortune points"},default:"remove",config:!0}),game.settings.register("zweihander","fortuneTrackerNotifications",{name:"Fortune Tracker Notification Behaviour",hint:"Choose how you wish to be notified about spent Fortune points.",scope:"world",type:String,choices:{none:"No Notifications (See current value on hovering tokens)",notify:"Post Foundry Notifications",chat:"Post Chat Messages"},default:"notify",config:!0}),game.settings.register("zweihander","fortuneTrackerSize",{name:"Fortune Tracker Size",hint:"Choose the size of your fortune tracker.",scope:"client",type:String,choices:{compact:"Compact (Text)",normal:"Normal (Tokens)",big:"Big (Tokens)",huge:"Huge (Tokens)"},default:"normal",config:!0}),game.settings.register("zweihander","fortuneTrackerFortunePath",{name:"Fortune Token Image",hint:"Customize the fortune token image. For best appearance use an image of at least 125x125 pixels.",scope:"world",type:String,default:"systems/zweihander/assets/fortune-life.png",config:!0}),game.settings.register("zweihander","fortuneTrackerMisfortunePath",{name:"Misfortune Token Image",hint:"Customize the misfortune token image. For best appearance use an image of at least 125x125 pixels.",scope:"world",type:String,default:"systems/zweihander/assets/fortune-death.png",config:!0})}#waiting=!1;#state={total:0,used:0,removed:0};#socket;#positions=[];#closable=!1;static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{template:"systems/zweihander/templates/fortune-tracker.hbs",popOut:!0,resizable:!1,title:"Fortune Tracker",id:"fortuneTrackerApp",classes:["zweihander"],width:2*FortuneTracker.PARAMS.areaSize,height:FortuneTracker.PARAMS.areaSize+30,top:60,left:125})}constructor(r){super();const i=this;r.register("requestSync",function(e,t){if(!e)return i.state;var a=i.validate(e,t);a?(r.executeForEveryone("broadcastState",i.state),r.executeAsUser("showIllegalStateNotification",t,a)):r.executeForEveryone("broadcastState",e)}),r.register("broadcastState",function(e){i.state=e}),r.register("showIllegalStateNotification",function(e){ui.notifications.error(e)}),this.#socket=r,this.generateRandomPositionValues()}get resetRule(){return"Set total fortune points to the number of connected players plus one."}get rules(){return game.settings.get("zweihander","fortuneTrackerRuleSystem")}get state(){return{total:this.#state.total,used:this.#state.used,removed:this.#state.removed}}set state(e){e.used===this.used&&e.removed===this.removed&&e.total===this.total||this.playAudio(),this.#waiting=!1,this.#state=e,game.users.get(game.userId).isGM&&(game.settings.set("zweihander","fortuneTrackerPersistedStateTotal",this.total),game.settings.set("zweihander","fortuneTrackerPersistedStateUsed",this.used),game.settings.set("zweihander","fortuneTrackerPersistedStateRemoved",this.removed)),this.render(!this.closable)}get total(){return this.#state.total}increaseTotal(){const e=this.state;return e.total++,e}decreaseTotal(){const e=this.state;return e.total--,e.total<e.used&&e.used--,e.total<e.removed&&e.removed--,e}spendFortune(){const e=this.state;return e.used++,e}spendMisfortune(){const e=this.state;return"keep"===this.rules?e.used--:e.removed++,e}get used(){return this.#state.used}get removed(){return this.#state.removed}get fortune(){return this.total-this.used}get misfortune(){return this.used-this.removed}generateRandomPositionValues(t=0,e=0){var a,r,i=20+2*e%20;for(let e=2*t%20;e<40;e++)(e<20||e>=i&&e<40)&&(this.#positions[e]=(a=FortuneTracker.PARAMS.padding,r=FortuneTracker.PARAMS.areaSize-FortuneTracker.PARAMS.tokenSize-FortuneTracker.PARAMS.padding,a=Math.ceil(a),r=Math.floor(r),Math.floor(Math.random()*(r-a+1)+a)))}validate(e,t){var a=game.settings.get("zweihander","fortuneTrackerNotifications"),r=game.users.get(t);return e.total===this.total||r.isGM?e.removed===this.removed||r.isGM?e.used<this.used&&!r.isGM?"You are not privileged to spend misfortune! Know your place, peasant!":e.total<0?"Sorry, but you can't have a negative amount of fortune. Kindly turn a demon or a foul god for the equivalent outcome!":e.used<0?"There is no misfortune left for the GM at this time.":e.removed<0?"Can't have negative removed tokens! (You should never see this error. If you do, please contact the developer.)":e.used>e.total?"There is no fortune left for the party at this time.":e.removed>e.used?"There is no misfortune left for the GM at this time.":(e.used===this.used+1?(r=r.charname||r.name,"notify"===a?ui.notifications.info(`${r} used a fortune point. Current fortune points: ${e.total-e.used}/`+e.total):"chat"===a&&ChatMessage.create({user:t,content:`${r} used a fortune point. Let's hope they make it count! <p><b>Current fortune points: ${e.total-e.used}/${e.total} </b></p>`})):e.remove!==this.remove+1&&e.used!==this.used-1||this.total!==e.total||("notify"===a?ui.notifications.info(`Brace yourselves, the GM used a misfortune point! Current fortune points: ${e.total-e.used}/`+e.total):"chat"===a&&ChatMessage.create({user:t,content:`Brace yourselves, the GM used a misfortune point! <p><b>Current fortune points: ${e.total-e.used}/${e.total} </b></p>`})),!1):"You are not privileged to spend misfortune! Know your place peasant, or be smited!":"You are not privileged to change the total amount of fortune in the game!"}getData(){this.generateRandomPositionValues(this.fortune,this.misfortune);let t=[];for(let e=0;e<this.fortune;e++){var a=this.#positions[e%10*2],r=this.#positions[e%10*2+1];t.push({t:a,l:r})}let i=[];for(let e=0;e<this.misfortune;e++){var n=this.#positions[e%10*2+20],s=this.#positions[e%10*2+21];i.push({t:n,l:s})}return{total:this.total,fortune:{value:this.fortune,positions:t,path:game.settings.get("zweihander","fortuneTrackerFortunePath")},misfortune:{value:this.misfortune,positions:i,path:game.settings.get("zweihander","fortuneTrackerMisfortunePath")},waiting:this.#waiting,params:FortuneTracker.PARAMS}}async syncState(){game.users.get(game.userId).isGM?(this.#state={total:game.settings.get("zweihander","fortuneTrackerPersistedStateTotal"),used:game.settings.get("zweihander","fortuneTrackerPersistedStateUsed"),removed:game.settings.get("zweihander","fortuneTrackerPersistedStateRemoved")},this.#waiting=!1,this.#socket.executeForOthers("broadcastState",this.state)):this.#state=await this.requestSync(),this.render(!this.closable)}resetState(){var e;game.users.get(game.userId).isGM?(e=game.users.players.map(e=>e.active?1:0).reduce((e,t)=>e+t,0),this.state={total:e+1,used:0,removed:0},this.#socket.executeForOthers("broadcastState",this.state)):ui.notifications.error("Only the GM may reset the fortune tracker. Keep your dirty hands to yourself, foolish thing!")}async requestSync(e){try{return e?await this.#socket.executeAsGM("requestSync",e,game.userId):await this.#socket.executeAsGM("requestSync")}catch(e){return console.error(e),this.#waiting=!0,this.render(!this.closable),ui.notifications.warn("Fortune Tracker is waiting for a GM to (re)connect."),this.state}}async close(){}activateListeners(e){const t=e.parents("#fortuneTrackerApp");let a;if(t.find("#fortuneTrackerAppTotal").length)t.find("#fortuneTrackerAppTotal").replaceWith(`<a id="fortuneTrackerAppTotal" class="waiting-${this.#waiting}">Total: ${this.total}</a>`),a=t.find("#fortuneTrackerAppTotal");else{t.find("a.header-button.close").before(`
        <a id="fortuneTrackerAppTotal" class="waiting-${this.#waiting}">
          Total: ${this.total}
        </a>
        <a class="fortune-tracker-reset" title="${this.resetRule}">
          <i class="fas fa-sync-alt"></i>
        </a>
      `);let e=t.find(".fortune-tracker-reset");e.click(e=>{e.preventDefault(),this.resetState()}),a=t.find("#fortuneTrackerAppTotal"),t.find("a.header-button.close").remove()}a.click(e=>{e.preventDefault(),this.requestSync(this.increaseTotal())}),a.contextmenu(e=>{e.preventDefault(),this.requestSync(this.decreaseTotal())});let r=e.find(".fortune-tracker-fortune-trigger");r.click(e=>{e.preventDefault(),this.requestSync(this.spendFortune())});let i=e.find(".fortune-tracker-misfortune-trigger");i.click(e=>{e.preventDefault(),this.requestSync(this.spendMisfortune())})}playAudio(){AudioHelper.play({src:"systems/zweihander/assets/sounds/coins.mp3",volume:.5,loop:!1},!0)}}const registerSystemSettings=function(){game.settings.register("zweihander","systemMigrationVersion",{name:"System Migration Version",scope:"world",config:!1,type:String,default:""}),game.settings.register("zweihander","encumbranceNineForOne",{name:"Small Item Encumbrance",hint:"Enable or disable rule for small item Encumbrance, where 9 small items add up to 1 point of Encumbrance.",scope:"world",type:Boolean,default:!0,config:!0}),game.settings.register("zweihander","trackRewardPoints",{name:"Automatically Track Reward Points",hint:"Enable or disable the automatic tracking of Reward Point expenditure.",scope:"world",type:Boolean,default:!0,config:!0}),game.settings.register("zweihander","theme",{name:"Zweihander Sheet Theme",hint:"Choose a theme for your Zweihander sheets",scope:"client",type:String,default:"gruvbox-dark",choices:{"gruvbox-dark":"Gruvbox Dark","gruvbox-light":"Gruvbox Light"},config:!0,onChange:a=>{$(".system-zweihander").addClass("zweihander-theme-"+a),$(".system-zweihander").removeClass((e,t)=>t.split(" ").filter(e=>e.startsWith("zweihander-theme-")&&e!=="zweihander-theme-"+a))}})},preloadHandlebarsTemplates=async function(){var e=e=>"systems/zweihander/templates/"+e+".hbs";return loadTemplates([e("pc/tab-afflictions"),e("pc/tab-background"),e("pc/tab-magick"),e("pc/tab-main"),e("pc/tab-tiers"),e("pc/tab-trappings"),e("pc/header"),e("item/ancestry"),e("item/armor"),e("item/condition"),e("item/disease"),e("item/disorder"),e("item/drawback"),e("item/injury"),e("item/profession"),e("item/ritual"),e("item/skill"),e("item/spell"),e("item/talent"),e("item/trait"),e("item/trapping"),e("item/quality"),e("item/uniqueAdvance"),e("item/weapon")])},registerHandlebarHelpers=async function(){function d(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16))}var e=(e,t)=>Handlebars.registerHelper(e,t);e("$$",function(e){return"systems/zweihander/templates/"+e+".hbs"}),e("getFirstLetter",function(e){return"string"!=typeof e?"":e.charAt(0).toUpperCase()}),e("capitalize",function(e){return"string"!=typeof e?"":e.capitalize()}),e("isMissing",function(e,t){return Array.isArray(e)?""===e[0]?t.inverse(this):t.fn(this):""===e?t.inverse(this):t.fn(this)}),e("oddOrEven",function(e){return(e+1)%2?"odd":"even"}),e("radioRanks",function(e,t,a){var r=a.hash.checked||null;let i="",n=0;var s,o,l=d();for([s,o]of Object.entries(t)){var c=r===s;i+=`<input type="radio" class="rd" name="${e}" id="${l}.${e+n}" value="${s}" ${c?"checked":""}><label for="${l}.${e+n++}">${o}</label>`}return new Handlebars.SafeString(i)}),e("radioThresholds",function(e,t,a){var r=a.hash.checked||null,i=a.hash.elem||"span";let n="";var s,o,l=d();for([s,o]of Object.entries(t)){var c=r==s;n+=`<div class="radio-and-status"><input type="radio" class="radio-rank" id="${l}.${s}" name="${e}" value="${s}" ${c?"checked":""}><${i} for="${l}.${s}" class="status">${o}</${i}></div>`}return new Handlebars.SafeString(n)}),e("checkUniqueAdvanceType",function(e,t){return"focus"===e.trim().toLowerCase()?`Focus (${t})`:e}),e("displayNpcSkillBonus",function(e){let t=0;for(var a of Object.keys(e)){if(!e[a].purchased)break;t+=10}return 0!==t?"+"+t:""}),e("rpSettingOn",function(e){return game.settings.get("zweihander","trackRewardPoints")?e.fn(this):e.inverse(this)}),e("generateResultText",function(e,t,a,r){var i=r?"*":"";switch(e){case 0:return new Handlebars.SafeString(`<span class="failure">Critical Failure</span> (${t} vs. ${a})`+i);case 1:return new Handlebars.SafeString(`<span class="failure">Failure</span> (${t} vs. ${a})`+i);case 2:return new Handlebars.SafeString(`<span class="success">Success</span> (${t} vs. ${a})`+i);case 3:return new Handlebars.SafeString(`<span class="success">Critical Success</span> (${t} vs. ${a})`+i)}}),e("generateFlipText",function(e){return"no-flip"===e?"No":"fail"===e?"To Fail":"To Succeed"}),e("checkSuccess",function(e,t){return 2<=e?t.fn(this):t.inverse(this)}),e("checkCriticalSuccess",function(e,t){return 3===e?t.fn(this):t.inverse(this)}),e("checkCriticalFailure",function(e,t){return 0===e?t.fn(this):t.inverse(this)}),e("displayIndividualDice",function(t,a,r){let i="";for(let e=0;e<t.length;e++){var n=t[e].results;for(let e=0;e<n.length;e++)r&&6===n[e].result?i+='<a class="highlight" title="Generate Chaos Manifestation">'+n[e].result+"</a>":i+=n[e].result,e!==n.length-1&&(i+=a);e!==t.length-1&&(i+=a)}return new Handlebars.SafeString(i)}),e("selectSpellDifficulty",function(e,t){switch(t){case"Petty":case"Generalist":return 0===e?"selected":"";case"Lesser":return 1===e?"selected":"";case"Greater":return 2===e?"selected":""}}),e("pa2Icon",function(e){return{combat:"ra ra-croc-sword",brawn:"ra ra-muscle-up",agility:"fa fa-running",perception:"ra ra-aware",intelligence:"ra ra-book",willpower:"ra ra-crystal-ball",fellowship:"ra ra-double-team"}[e]}),e("markdownIt",function(e){return window.MEME?.markdownIt?.render?window.MEME?.markdownIt?.render(e):e}),e("itemTemplatePath",function(e){return"systems/zweihander/templates/item/"+e+".hbs"}),e("itemImageClass",function(e){return e.endsWith(".svg")?"item-image item-image-icon":"item-image item-image-picture"}),e("itemImageStyle",function(e){return e.endsWith(".svg")?`-webkit-mask-image: url('${e}')`:`background-image: url('${e}')`}),e("arrayInputGroup",function(e,t,a,r=Number.MAX_SAFE_INTEGER,i){return`<div class="form-group">
    <label>${e}</label>
    <div class="array-input flexrow" data-array-input-target="${t}" data-array-input-max="${r}">
      <input name="proxy.${t}" type="text" placeholder="Enter values here">
      <button class="array-input-plus" type="button" tabindex="-1"><i class="fas fa-plus"></i></button>
      <div class="array-input-pills">
        ${a.map((e,t)=>`
          <span class="array-input-pill" data-array-input-index="${t}">${e[i]??e}</span>
        `)}
      </div>
    </div>
  </div>`}),e("skillBonus",function(e){return e?"+"+e:""}),e("skillRankAbbreviation",function(e){return["-","Appr.","Jour.","Mstr."][e]})},migrateWorld=async function(){ui.notifications.info(`Applying Zweihander System Migration for version ${game.system.data.version}. Please be patient and do not close your game or shut down your server.`,{permanent:!0});for(var t of game.actors)try{var e=await migrateActorData(t);foundry.utils.isObjectEmpty(e)||(console.log("Migrating Actor document "+t.name),await t.update(e,{enforceTypes:!1}))}catch(e){e.message=`Failed Zweihander system migration for Actor ${t.name}: `+e.message,console.error(e)}for(var a of game.items)try{var r=await migrateItemData(a);foundry.utils.isObjectEmpty(r)||(console.log("Migrating Item document "+a.name),await a.update(r,{enforceTypes:!1}))}catch(e){e.message=`Failed Zweihander system migration for Item ${a.name}: `+e.message,console.error(e)}for(var i of game.packs)["Actor","Item","Scene"].includes(i.documentName)&&await migrateCompendium(i);game.settings.set("zweihander","systemMigrationVersion",game.system.data.version),ui.notifications.info(`Zweihander System Migration to version ${game.system.data.version} completed!`,{permanent:!0})},migrateCompendium=async function(t){var a=t.documentName;if(["Actor","Item"].includes(a)){var r,e=t.locked;await t.configure({locked:!1});for(r of await t.getDocuments()){let e={};try{if("Item"===a&&(e=await migrateItemData(r)),foundry.utils.isObjectEmpty(e))continue;await r.update(e),console.log(`Migrated ${a} entity ${r.name} in Compendium `+t.collection)}catch(e){e.message=`Failed Zweihander system migration for entity ${r.name} in pack ${t.collection}: `+e.message,console.error(e)}}await t.migrate(),await t.configure({locked:e}),console.log(`Migrated all ${a} entities from Compendium `+t.collection)}},migrateActorData=async function(e){const t={};if(e.data,!e.items)return t;const a=[];for(var r of e.items){let e=await migrateItemData(r);isObjectEmpty(e)||(e._id=r.id,a.push(expandObject(e)))}return 0<a.length&&(t.items=a),t},migrateItemData=async function(e){let t={};return"ancestry"===e.type?t=await migrateAncestry(e):"profession"===e.type?t=await migrateProfession(e):["trait","talent","drawback"].includes(e.type),t},migrateAncestry=async function(e){var t=e.actor;let a=(e=e.toObject()).data.ancestralTrait.linkedId??null,r=e.data.ancestralTrait.value;return t&&r&&!a&&(t=await ZweihanderBaseItem.getOrCreateLinkedItem(t,r,"trait",e.name,"ancestry"),a=t.linkedId,r=t.value),{"data.ancestralTrait.value":r,"data.ancestralTrait.linkedId":a,"data.ancestralModifiers.positive":e.data.ancestralModifiers.positive?.value?.split(",")?.map(e=>e.trim())??e.data.ancestralModifiers.positive,"data.ancestralModifiers.negative":e.data.ancestralModifiers.negative?.value?.split(",")?.map(e=>e.trim())??e.data.ancestralModifiers.negative}},migrateProfession=async function(t){var a=t.actor;t.pack;var e=(t=t.toObject()).data.bonusAdvances?.arrayOfValues?.map(e=>({value:e.name.trim(),purchased:e.purchased}))??t.data.bonusAdvances?.value?.split(",")?.map(e=>({value:e.trim(),purchased:!1}))??t.data.bonusAdvances;let r=t.data.talents?.arrayOfValues?.map(e=>({value:e.name.trim(),linkedId:null,purchased:e.purchased}))??t.data.talents?.value?.split(",")?.map(e=>({value:e.trim(),linkedId:null,purchased:!1}))??t.data.talents.map(e=>({value:e.value.trim(),linkedId:e.linkedId??null,purchased:e.purchased}));var i=a?.data?.data?.tier,n=t.data.tier?.value;const s=i&&i!==n;i=t.data.skillRanks?.arrayOfValues?.map(e=>({value:e.name.trim(),purchased:s||0===e.timesAvailable}))??t.data.skillRanks?.value?.split(",")?.map(e=>({value:e.trim(),purchased:!1}))??t.data.skillRanks;let o=t.data.professionalTrait.value,l=t.data.professionalTrait.linkedId??null,c=t.data.specialTrait.value,d=t.data.specialTrait.linkedId??null,u=t.data.drawback.value,f=t.data.drawback.linkedId??null;if(a){let e;o&&!l&&(e=await ZweihanderBaseItem.getOrCreateLinkedItem(a,o,"trait",t.name,"profession"),o=e.value,l=e.linkedId),c&&!d&&(e=await ZweihanderBaseItem.getOrCreateLinkedItem(a,c,"trait",t.name,"profession"),c=e.value,d=e.linkedId),u&&!f&&(e=await ZweihanderBaseItem.getOrCreateLinkedItem(a,u,"drawback",t.name,"profession"),u=e.value,f=e.linkedId);n=r.filter(e=>!e.linkedId&&e.value).map(e=>e.value);n.length&&(e=await ZweihanderBaseItem.getOrCreateLinkedItems(a,n,"talent",t.name,"profession"),r=e.map((e,t)=>({...e,purchased:r[t].purchased||!1})))}return{"data.bonusAdvances":e,"data.professionalTrait.value":o,"data.professionalTrait.linkedId":l,"data.specialTrait.value":c,"data.specialTrait.linkedId":d,"data.drawback.value":u,"data.drawback.linkedId":f,"data.skillRanks":i,"data.talents":r,"data.tier.-=completed":null,"data.tier.-=advancesPurchased":null,"data.tier.value":t?.flags?.zweihander?.professionTier??t.data.tier.value,"flags.zweihander.-=professionTier":null}},migrateWorldSafe=async function(){if(game.user.isGM){var e=game.settings.get("zweihander","systemMigrationVersion"),t=game.actors.size+game.scenes.size+game.items.size;if(!e&&0===t)return game.settings.set("zweihander","systemMigrationVersion",game.system.data.version);(!e||isNewerVersion("0.3.30",e))&&(e&&isNewerVersion("0.3.30",e)&&ui.notifications.error("Your Zweihander system data is from too old a Foundry version and cannot be reliably migrated to the latest version. The process will be attempted, but errors may occur.",{permanent:!0}),await migrateWorld())}};var commonjsGlobal="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},intro={exports:{}};intro.exports=function(){function i(e){"@babel/helpers - typeof";if(typeof Symbol==="function"&&typeof Symbol.iterator==="symbol")i=function(e){return typeof e};else i=function(e){return e&&typeof Symbol==="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};return i(e)}function a(e,t){var a={};var r;for(r in e)a[r]=e[r];for(r in t)a[r]=t[r];return a}var n=function(){var r={};return function e(t){var a=arguments.length>1&&arguments[1]!==undefined?arguments[1]:"introjs-stamp";r[a]=r[a]||0;if(t[a]===undefined)t[a]=r[a]++;return t[a]}}();function c(e,t,a){if(e)for(var r=0,i=e.length;r<i;r++)t(e[r],r);if(typeof a==="function")a()}var l=function(){function e(){var o="introjs_event";this._id=function(e,t,a,r){return t+n(a)+(r?"_".concat(n(r)):"")};this.on=function(a,e,r,i,t){var n=this._id.apply(this,arguments);var s=function e(t){return r.call(i||a,t||window.event)};if("addEventListener"in a)a.addEventListener(e,s,t);else if("attachEvent"in a)a.attachEvent("on".concat(e),s);a[o]=a[o]||{};a[o][n]=s};this.off=function(e,t,a,r,i){var n=this._id.apply(this,arguments);var s=e[o]&&e[o][n];if(!s)return;if("removeEventListener"in e)e.removeEventListener(t,s,i);else if("detachEvent"in e)e.detachEvent("on".concat(t),s);e[o][n]=null}}return new e}(),e=typeof globalThis!=="undefined"?globalThis:typeof window!=="undefined"?window:typeof commonjsGlobal!=="undefined"?commonjsGlobal:typeof self!=="undefined"?self:{};function t(e,t){return t={exports:{}},e(t,t.exports),t.exports}var r=function(e){return e&&e.Math==Math&&e},f=r(typeof globalThis=="object"&&globalThis)||r(typeof window=="object"&&window)||r(typeof self=="object"&&self)||r(typeof e=="object"&&e)||function(){return this}()||Function("return this")(),d=function(e){try{return!!e()}catch(e){return true}},p=!d(function(){return Object.defineProperty({},1,{get:function(){return 7}})[1]!=7}),s=Function.prototype.call,y=s.bind?s.bind(s):function(){return s.apply(s,arguments)},o={}.propertyIsEnumerable,u=Object.getOwnPropertyDescriptor,h,m,g={f:u&&!o.call({1:2},1)?function e(t){var a=u(this,t);return!!a&&a.enumerable}:o},v=function(e,t){return{enumerable:!(e&1),configurable:!(e&2),writable:!(e&4),value:t}},b=Function.prototype,w=b.bind,k=b.call,S=w&&w.bind(k),C=w?function(e){return e&&S(k,e)}:function(e){return e&&function(){return k.apply(e,arguments)}},_=C({}.toString),A=C("".slice),T=function(e){return A(_(e),8,-1)},I=f.Object,E=C("".split),x=d(function(){return!I("z").propertyIsEnumerable(0)})?function(e){return T(e)=="String"?E(e,""):I(e)}:I,j=f.TypeError,D=function(e){if(e==undefined)throw j("Can't call method on "+e);return e},O=function(e){return x(D(e))},N=function(e){return typeof e=="function"},P=function(e){return typeof e=="object"?e!==null:N(e)},R=function(e){return N(e)?e:undefined},$=function(e,t){return arguments.length<2?R(f[e]):f[e]&&f[e][t]},M=C({}.isPrototypeOf),z=$("navigator","userAgent")||"",L=f.process,B=f.Deno,F=L&&L.versions||B&&B.version,Z=F&&F.v8,q,W;if(Z){q=Z.split(".");W=q[0]>0&&q[0]<4?1:+(q[0]+q[1])}if(!W&&z){q=z.match(/Edge\/(\d+)/);if(!q||q[1]>=74){q=z.match(/Chrome\/(\d+)/);if(q)W=+q[1]}}var G=W,H=!!Object.getOwnPropertySymbols&&!d(function(){var e=Symbol();return!String(e)||!(Object(e)instanceof Symbol)||!Symbol.sham&&G&&G<41}),U=H&&!Symbol.sham&&typeof Symbol.iterator=="symbol",V=f.Object,Y=U?function(e){return typeof e=="symbol"}:function(e){var t=$("Symbol");return N(t)&&M(t.prototype,V(e))},K=f.String,J=function(e){try{return K(e)}catch(e){return"Object"}},X=f.TypeError,Q=function(e){if(N(e))return e;throw X(J(e)+" is not a function")},ee=function(e,t){var a=e[t];return a==null?undefined:Q(a)},te=f.TypeError,ae=function(e,t){var a,r;if(t==="string"&&N(a=e.toString)&&!P(r=y(a,e)))return r;if(N(a=e.valueOf)&&!P(r=y(a,e)))return r;if(t!=="string"&&N(a=e.toString)&&!P(r=y(a,e)))return r;throw te("Can't convert object to primitive value")},re=Object.defineProperty,ie=function(t,a){try{re(f,t,{value:a,configurable:true,writable:true})}catch(e){f[t]=a}return a},ne="__core-js_shared__",se,oe=f[ne]||ie(ne,{}),le=t(function(e){(e.exports=function(e,t){return oe[e]||(oe[e]=t!==undefined?t:{})})("versions",[]).push({version:"3.19.1",mode:"global",copyright:"© 2021 Denis Pushkarev (zloirock.ru)"})}),ce=f.Object,de=function(e){return ce(D(e))},ue=C({}.hasOwnProperty),fe=Object.hasOwn||function e(t,a){return ue(de(t),a)},pe=0,he=Math.random(),me=C(1..toString),ge=function(e){return"Symbol("+(e===undefined?"":e)+")_"+me(++pe+he,36)},ve=le("wks"),be=f.Symbol,ye=be&&be["for"],we=U?be:be&&be.withoutSetter||ge,ke=function(e){if(!fe(ve,e)||!(H||typeof ve[e]=="string")){var t="Symbol."+e;if(H&&fe(be,e))ve[e]=be[e];else if(U&&ye)ve[e]=ye(t);else ve[e]=we(t)}return ve[e]},Se=f.TypeError,Ce=ke("toPrimitive"),_e=function(e,t){if(!P(e)||Y(e))return e;var a=ee(e,Ce);var r;if(a){if(t===undefined)t="default";r=y(a,e,t);if(!P(r)||Y(r))return r;throw Se("Can't convert object to primitive value")}if(t===undefined)t="number";return ae(e,t)},Ae=function(e){var t=_e(e,"string");return Y(t)?t:t+""},Te=f.document,Ie=P(Te)&&P(Te.createElement),Ee=function(e){return Ie?Te.createElement(e):{}},xe=!p&&!d(function(){return Object.defineProperty(Ee("div"),"a",{get:function(){return 7}}).a!=7}),je=Object.getOwnPropertyDescriptor,De,Oe={f:p?je:function e(t,a){t=O(t);a=Ae(a);if(xe)try{return je(t,a)}catch(e){}if(fe(t,a))return v(!y(g.f,t,a),t[a])}},Ne=f.String,Pe=f.TypeError,Re=function(e){if(P(e))return e;throw Pe(Ne(e)+" is not an object")},$e=f.TypeError,Me=Object.defineProperty,ze,Le={f:p?Me:function e(t,a,r){Re(t);a=Ae(a);Re(r);if(xe)try{return Me(t,a,r)}catch(e){}if("get"in r||"set"in r)throw $e("Accessors not supported");if("value"in r)t[a]=r.value;return t}},Be=p?function(e,t,a){return Le.f(e,t,v(1,a))}:function(e,t,a){e[t]=a;return e},Fe=C(Function.toString);if(!N(oe.inspectSource))oe.inspectSource=function(e){return Fe(e)};var Ze=oe.inspectSource,qe=f.WeakMap,We=N(qe)&&/native code/.test(Ze(qe)),Ge=le("keys"),He=function(e){return Ge[e]||(Ge[e]=ge(e))},Ue={},Ve="Object already initialized",Ye=f.TypeError,Ke=f.WeakMap,Je,Xe,Qe,et=function(e){return Qe(e)?Xe(e):Je(e,{})},tt=function(a){return function(e){var t;if(!P(e)||(t=Xe(e)).type!==a)throw Ye("Incompatible receiver, "+a+" required");return t}};if(We||oe.state){var at=oe.state||(oe.state=new Ke);var rt=C(at.get);var it=C(at.has);var nt=C(at.set);Je=function(e,t){if(it(at,e))throw new Ye(Ve);t.facade=e;nt(at,e,t);return t};Xe=function(e){return rt(at,e)||{}};Qe=function(e){return it(at,e)}}else{var st=He("state");Ue[st]=true;Je=function(e,t){if(fe(e,st))throw new Ye(Ve);t.facade=e;Be(e,st,t);return t};Xe=function(e){return fe(e,st)?e[st]:{}};Qe=function(e){return fe(e,st)}}var ot={set:Je,get:Xe,has:Qe,enforce:et,getterFor:tt},lt=Function.prototype,ct=p&&Object.getOwnPropertyDescriptor,dt=fe(lt,"name"),ut,ft,pt={EXISTS:dt,PROPER:dt&&function e(){}.name==="something",CONFIGURABLE:dt&&(!p||p&&ct(lt,"name").configurable)},ht=t(function(e){var c=pt.CONFIGURABLE;var t=ot.get;var d=ot.enforce;var u=String(String).split("String");(e.exports=function(e,t,a,r){var i=r?!!r.unsafe:false;var n=r?!!r.enumerable:false;var s=r?!!r.noTargetGet:false;var o=r&&r.name!==undefined?r.name:t;var l;if(N(a)){if(String(o).slice(0,7)==="Symbol(")o="["+String(o).replace(/^Symbol\(([^)]*)\)/,"$1")+"]";if(!fe(a,"name")||c&&a.name!==o)Be(a,"name",o);l=d(a);if(!l.source)l.source=u.join(typeof o=="string"?o:"")}if(e===f){if(n)e[t]=a;else ie(t,a);return}else if(!i)delete e[t];else if(!s&&e[t])n=true;if(n)e[t]=a;else Be(e,t,a)})(Function.prototype,"toString",function e(){return N(this)&&t(this).source||Ze(this)})}),mt=Math.ceil,gt=Math.floor,vt=function(e){var t=+e;return t!==t||t===0?0:(t>0?gt:mt)(t)},bt=Math.max,yt=Math.min,wt=function(e,t){var a=vt(e);return a<0?bt(a+t,0):yt(a,t)},kt=Math.min,St=function(e){return e>0?kt(vt(e),9007199254740991):0},Ct=function(e){return St(e.length)},_t=function(o){return function(e,t,a){var r=O(e);var i=Ct(r);var n=wt(a,i);var s;if(o&&t!=t)while(i>n){s=r[n++];if(s!=s)return true}else for(;i>n;n++)if((o||n in r)&&r[n]===t)return o||n||0;return!o&&-1}},At={includes:_t(true),indexOf:_t(false)},Tt=At.indexOf,It=C([].push),Et=function(e,t){var a=O(e);var r=0;var i=[];var n;for(n in a)!fe(Ue,n)&&fe(a,n)&&It(i,n);while(t.length>r)if(fe(a,n=t[r++]))~Tt(i,n)||It(i,n);return i},xt=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],jt=xt.concat("length","prototype"),Dt,Ot={f:Object.getOwnPropertyNames||function e(t){return Et(t,jt)}},Nt,Pt={f:Object.getOwnPropertySymbols},Rt=C([].concat),$t=$("Reflect","ownKeys")||function e(t){var a=Ot.f(Re(t));var r=Pt.f;return r?Rt(a,r(t)):a},Mt=function(e,t){var a=$t(t);var r=Le.f;var i=Oe.f;for(var n=0;n<a.length;n++){var s=a[n];if(!fe(e,s))r(e,s,i(t,s))}},zt=/#|\.prototype\./,Lt=function(e,t){var a=Ft[Bt(e)];return a==qt?true:a==Zt?false:N(t)?d(t):!!t},Bt=Lt.normalize=function(e){return String(e).replace(zt,".").toLowerCase()},Ft=Lt.data={},Zt=Lt.NATIVE="N",qt=Lt.POLYFILL="P",Wt=Lt,Gt=Oe.f,Ht=function(e,t){var a=e.target;var r=e.global;var i=e.stat;var n,s,o,l,c,d;if(r)s=f;else if(i)s=f[a]||ie(a,{});else s=(f[a]||{}).prototype;if(s)for(o in t){c=t[o];if(e.noTargetGet){d=Gt(s,o);l=d&&d.value}else l=s[o];n=Wt(r?o:a+(i?".":"#")+o,e.forced);if(!n&&l!==undefined){if(typeof c==typeof l)continue;Mt(c,l)}if(e.sham||l&&l.sham)Be(c,"sham",true);ht(s,o,c,e)}},Ut,Vt={};Vt[ke("toStringTag")]="z";var Yt=String(Vt)==="[object z]",Kt=ke("toStringTag"),Jt=f.Object,Xt=T(function(){return arguments}())=="Arguments",Qt=function(e,t){try{return e[t]}catch(e){}},ea=Yt?T:function(e){var t,a,r;return e===undefined?"Undefined":e===null?"Null":typeof(a=Qt(t=Jt(e),Kt))=="string"?a:Xt?T(t):(r=T(t))=="Object"&&N(t.callee)?"Arguments":r},ta=f.String,aa=function(e){if(ea(e)==="Symbol")throw TypeError("Cannot convert a Symbol value to a string");return ta(e)},ra=function(){var e=Re(this);var t="";if(e.global)t+="g";if(e.ignoreCase)t+="i";if(e.multiline)t+="m";if(e.dotAll)t+="s";if(e.unicode)t+="u";if(e.sticky)t+="y";return t},ia=f.RegExp,na,sa,oa={UNSUPPORTED_Y:d(function(){var e=ia("a","y");e.lastIndex=2;return e.exec("abcd")!=null}),BROKEN_CARET:d(function(){var e=ia("^r","gy");e.lastIndex=2;return e.exec("str")!=null})},la=Object.keys||function e(t){return Et(t,xt)},ca=p?Object.defineProperties:function e(t,a){Re(t);var r=O(a);var i=la(a);var n=i.length;var s=0;var o;while(n>s)Le.f(t,o=i[s++],r[o]);return t},da=$("document","documentElement"),ua=">",fa="<",pa="prototype",ha="script",ma=He("IE_PROTO"),ga=function(){},va=function(e){return fa+ha+ua+e+fa+"/"+ha+ua},ba=function(e){e.write(va(""));e.close();var t=e.parentWindow.Object;e=null;return t},ya=function(){var e=Ee("iframe");var t="java"+ha+":";var a;e.style.display="none";da.appendChild(e);e.src=String(t);a=e.contentWindow.document;a.open();a.write(va("document.F=Object"));a.close();return a.F},wa,ka=function(){try{wa=new ActiveXObject("htmlfile")}catch(e){}ka=typeof document!="undefined"?document.domain&&wa?ba(wa):ya():ba(wa);var e=xt.length;while(e--)delete ka[pa][xt[e]];return ka()};Ue[ma]=true;var Sa=Object.create||function e(t,a){var r;if(t!==null){ga[pa]=Re(t);r=new ga;ga[pa]=null;r[ma]=t}else r=ka();return a===undefined?r:ca(r,a)},Ca=f.RegExp,_a=d(function(){var e=Ca(".","s");return!(e.dotAll&&e.exec("\n")&&e.flags==="s")}),Aa=f.RegExp,Ta=d(function(){var e=Aa("(?<a>b)","g");return e.exec("b").groups.a!=="b"||"b".replace(e,"$<a>c")!=="bc"}),Ia=ot.get,Ea=le("native-string-replace",String.prototype.replace),xa=RegExp.prototype.exec,ja=xa,Da=C("".charAt),Oa=C("".indexOf),Na=C("".replace),Pa=C("".slice),Ra=function(){var e=/a/;var t=/b*/g;y(xa,e,"a");y(xa,t,"a");return e.lastIndex!==0||t.lastIndex!==0}(),$a=oa.UNSUPPORTED_Y||oa.BROKEN_CARET,Ma=/()??/.exec("")[1]!==undefined,za;if(Ra||Ma||$a||_a||Ta)ja=function e(t){var a=this;var r=Ia(a);var i=aa(t);var n=r.raw;var s,o,l,c,d,u,f;if(n){n.lastIndex=a.lastIndex;s=y(ja,n,i);a.lastIndex=n.lastIndex;return s}var p=r.groups;var h=$a&&a.sticky;var m=y(ra,a);var g=a.source;var v=0;var b=i;if(h){m=Na(m,"y","");if(Oa(m,"g")===-1)m+="g";b=Pa(i,a.lastIndex);if(a.lastIndex>0&&(!a.multiline||a.multiline&&Da(i,a.lastIndex-1)!=="\n")){g="(?: "+g+")";b=" "+b;v++}o=new RegExp("^(?:"+g+")",m)}if(Ma)o=new RegExp("^"+g+"$(?!\\s)",m);if(Ra)l=a.lastIndex;c=y(xa,h?o:a,b);if(h)if(c){c.input=Pa(c.input,v);c[0]=Pa(c[0],v);c.index=a.lastIndex;a.lastIndex+=c[0].length}else a.lastIndex=0;else if(Ra&&c)a.lastIndex=a.global?c.index+c[0].length:l;if(Ma&&c&&c.length>1)y(Ea,c[0],o,function(){for(d=1;d<arguments.length-2;d++)if(arguments[d]===undefined)c[d]=undefined});if(c&&p){c.groups=u=Sa(null);for(d=0;d<p.length;d++){f=p[d];u[f[0]]=c[f[1]]}}return c};var La=ja;Ht({target:"RegExp",proto:true,forced:/./.exec!==La},{exec:La});var Ba=ke("species"),Fa=RegExp.prototype,Za=function(a,e,t,r){var i=ke(a);var o=!d(function(){var e={};e[i]=function(){return 7};return""[a](e)!=7});var n=o&&!d(function(){var e=false;var t=/a/;if(a==="split"){t={};t.constructor={};t.constructor[Ba]=function(){return t};t.flags="";t[i]=/./[i]}t.exec=function(){e=true;return null};t[i]("");return!e});if(!o||!n||t){var l=C(/./[i]);var s=e(i,""[a],function(e,t,a,r,i){var n=C(e);var s=t.exec;if(s===La||s===Fa.exec){if(o&&!i)return{done:true,value:l(t,a,r)};return{done:true,value:n(a,t,r)}}return{done:false}});ht(String.prototype,a,s[0]);ht(Fa,i,s[1])}if(r)Be(Fa[i],"sham",true)},qa=C("".charAt),Wa=C("".charCodeAt),Ga=C("".slice),Ha=function(o){return function(e,t){var a=aa(D(e));var r=vt(t);var i=a.length;var n,s;if(r<0||r>=i)return o?"":undefined;n=Wa(a,r);return n<55296||n>56319||r+1===i||(s=Wa(a,r+1))<56320||s>57343?o?qa(a,r):n:o?Ga(a,r,r+2):(n-55296<<10)+(s-56320)+65536}},Ua,Va={codeAt:Ha(false),charAt:Ha(true)}.charAt,Ya=function(e,t,a){return t+(a?Va(e,t).length:1)},Ka=f.TypeError,Ja=function(e,t){var a=e.exec;if(N(a)){var r=y(a,e,t);if(r!==null)Re(r);return r}if(T(e)==="RegExp")return y(La,e,t);throw Ka("RegExp#exec called on incompatible receiver")};Za("match",function(i,c,d){return[function e(t){var a=D(this);var r=t==undefined?undefined:ee(t,i);return r?y(r,t,a):new RegExp(t)[i](aa(a))},function(e){var t=Re(this);var a=aa(e);var r=d(c,t,a);if(r.done)return r.value;if(!t.global)return Ja(t,a);var i=t.unicode;t.lastIndex=0;var n=[];var s=0;var o;while((o=Ja(t,a))!==null){var l=aa(o[0]);n[s]=l;if(l==="")t.lastIndex=Ya(a,St(t.lastIndex),i);s++}return s===0?null:n}]});var Xa=Array.isArray||function e(t){return T(t)=="Array"},Qa=function(e,t,a){var r=Ae(t);if(r in e)Le.f(e,r,v(0,a));else e[r]=a},er=function(){},tr=[],ar=$("Reflect","construct"),rr=/^\s*(?:class|function)\b/,ir=C(rr.exec),nr=!rr.exec(er),sr=function(e){if(!N(e))return false;try{ar(er,tr,e);return true}catch(e){return false}},or=function(e){if(!N(e))return false;switch(ea(e)){case"AsyncFunction":case"GeneratorFunction":case"AsyncGeneratorFunction":return false}return nr||!!ir(rr,Ze(e))},lr=!ar||d(function(){var e;return sr(sr.call)||!sr(Object)||!sr(function(){e=true})||e})?or:sr,cr=ke("species"),dr=f.Array,ur=function(e){var t;if(Xa(e)){t=e.constructor;if(lr(t)&&(t===dr||Xa(t.prototype)))t=undefined;else if(P(t)){t=t[cr];if(t===null)t=undefined}}return t===undefined?dr:t},fr=function(e,t){return new(ur(e))(t===0?0:t)},pr=ke("species"),hr=function(a){return G>=51||!d(function(){var e=[];var t=e.constructor={};t[pr]=function(){return{foo:1}};return e[a](Boolean).foo!==1})},mr=ke("isConcatSpreadable"),gr=9007199254740991,vr="Maximum allowed index exceeded",br=f.TypeError,yr=G>=51||!d(function(){var e=[];e[mr]=false;return e.concat()[0]!==e}),wr=hr("concat"),kr=function(e){if(!P(e))return false;var t=e[mr];return t!==undefined?!!t:Xa(e)},Sr,Cr;if(Ht({target:"Array",proto:true,forced:!yr||!wr},{concat:function e(t){var a=de(this);var r=fr(a,0);var i=0;var n,s,o,l,c;for(n=-1,o=arguments.length;n<o;n++){c=n===-1?a:arguments[n];if(kr(c)){l=Ct(c);if(i+l>gr)throw br(vr);for(s=0;s<l;s++,i++)if(s in c)Qa(r,i,c[s])}else{if(i>=gr)throw br(vr);Qa(r,i++,c)}}r.length=i;return r}}),!Yt)ht(Object.prototype,"toString",Yt?{}.toString:function e(){return"[object "+ea(this)+"]"},{unsafe:true});var _r=pt.PROPER,Ar="toString",Tr=RegExp.prototype,Ir=Tr[Ar],Er=C(ra),xr=d(function(){return Ir.call({source:"a",flags:"b"})!="/a/b"}),jr=_r&&Ir.name!=Ar;if(xr||jr)ht(RegExp.prototype,Ar,function e(){var t=Re(this);var a=aa(t.source);var r=t.flags;var i=aa(r===undefined&&M(Tr,t)&&!("flags"in Tr)?Er(t):r);return"/"+a+"/"+i},{unsafe:true});var Dr=Function.prototype,Or=Dr.apply,Nr=Dr.bind,Pr=Dr.call,Rr=typeof Reflect=="object"&&Reflect.apply||(Nr?Pr.bind(Or):function(){return Pr.apply(Or,arguments)}),$r=ke("match"),Mr=function(e){var t;return P(e)&&((t=e[$r])!==undefined?!!t:T(e)=="RegExp")},zr=f.TypeError,Lr=function(e){if(lr(e))return e;throw zr(J(e)+" is not a constructor")},Br=ke("species"),Fr=function(e,t){var a=Re(e).constructor;var r;return a===undefined||(r=Re(a)[Br])==undefined?t:Lr(r)},Zr=C([].slice),qr=oa.UNSUPPORTED_Y,Wr=4294967295,Gr=Math.min,Hr=[].push,Ur=C(/./.exec),Vr=C(Hr),Yr=C("".slice),Kr;function Jr(t,e){if(t instanceof SVGElement){var a=t.getAttribute("class")||"";if(!a.match(e))t.setAttribute("class","".concat(a," ").concat(e))}else if(t.classList!==undefined){var r=e.split(" ");c(r,function(e){t.classList.add(e)})}else if(!t.className.match(e))t.className+=" ".concat(e)}function Xr(e,t){var a="";if(e.currentStyle)a=e.currentStyle[t];else if(document.defaultView&&document.defaultView.getComputedStyle)a=document.defaultView.getComputedStyle(e,null).getPropertyValue(t);if(a&&a.toLowerCase)return a.toLowerCase();else return a}function Qr(e){var t=e.element;Jr(t,"introjs-showElement");var a=Xr(t,"position");if(a!=="absolute"&&a!=="relative"&&a!=="sticky"&&a!=="fixed")Jr(t,"introjs-relativePosition")}function ei(e){var t=window.getComputedStyle(e);var a=t.position==="absolute";var r=/(auto|scroll)/;if(t.position==="fixed")return document.body;for(var i=e;i=i.parentElement;){t=window.getComputedStyle(i);if(a&&t.position==="static")continue;if(r.test(t.overflow+t.overflowY+t.overflowX))return i}return document.body}function ti(e){var t=e.element;if(!this._options.scrollToElement)return;var a=ei(t);if(a===document.body)return;a.scrollTop=t.offsetTop-a.offsetTop}function ai(){if(window.innerWidth!==undefined)return{width:window.innerWidth,height:window.innerHeight};else{var e=document.documentElement;return{width:e.clientWidth,height:e.clientHeight}}}function ri(e){var t=e.getBoundingClientRect();return t.top>=0&&t.left>=0&&t.bottom+80<=window.innerHeight&&t.right<=window.innerWidth}function ii(e,t,a){var r=t.element;if(e==="off")return;var i;if(!this._options.scrollToElement)return;if(e==="tooltip")i=a.getBoundingClientRect();else i=r.getBoundingClientRect();if(!ri(r)){var n=ai().height;var s=i.bottom-(i.bottom-i.top);if(s<0||r.clientHeight>n)window.scrollBy(0,i.top-(n/2-i.height/2)-this._options.scrollPadding);else window.scrollBy(0,i.top-(n/2-i.height/2)+this._options.scrollPadding)}}function ni(e){e.setAttribute("role","button");e.tabIndex=0}Za("split",function(n,g,v){var b;if("abbc".split(/(b)*/)[1]=="c"||"test".split(/(?:)/,-1).length!=4||"ab".split(/(?:ab)*/).length!=2||".".split(/(.?)(.?)/).length!=4||".".split(/()()/).length>1||"".split(/.?/).length)b=function(e,t){var a=aa(D(this));var r=t===undefined?Wr:t>>>0;if(r===0)return[];if(e===undefined)return[a];if(!Mr(e))return y(g,a,e,r);var i=[];var n=(e.ignoreCase?"i":"")+(e.multiline?"m":"")+(e.unicode?"u":"")+(e.sticky?"y":"");var s=0;var o=new RegExp(e.source,n+"g");var l,c,d;while(l=y(La,o,a)){c=o.lastIndex;if(c>s){Vr(i,Yr(a,s,l.index));if(l.length>1&&l.index<a.length)Rr(Hr,i,Zr(l,1));d=l[0].length;s=c;if(i.length>=r)break}if(o.lastIndex===l.index)o.lastIndex++}if(s===a.length){if(d||!Ur(o,""))Vr(i,"")}else Vr(i,Yr(a,s));return i.length>r?Zr(i,0,r):i};else if("0".split(undefined,0).length)b=function(e,t){return e===undefined&&t===0?[]:y(g,this,e,t)};else b=g;return[function e(t,a){var r=D(this);var i=t==undefined?undefined:ee(t,n);return i?y(i,t,r,a):y(b,aa(r),t,a)},function(e,t){var a=Re(this);var r=aa(e);var i=v(b,a,r,t,b!==g);if(i.done)return i.value;var n=Fr(a,RegExp);var s=a.unicode;var o=(a.ignoreCase?"i":"")+(a.multiline?"m":"")+(a.unicode?"u":"")+(qr?"g":"y");var l=new n(qr?"^(?:"+a.source+")":a,o);var c=t===undefined?Wr:t>>>0;if(c===0)return[];if(r.length===0)return Ja(l,r)===null?[r]:[];var d=0;var u=0;var f=[];while(u<r.length){l.lastIndex=qr?0:u;var p=Ja(l,qr?Yr(r,u):r);var h;if(p===null||(h=Gr(St(l.lastIndex+(qr?u:0)),r.length))===d)u=Ya(r,u,s);else{Vr(f,Yr(r,d,u));if(f.length===c)return f;for(var m=1;m<=p.length-1;m++){Vr(f,p[m]);if(f.length===c)return f}u=d=h}}Vr(f,Yr(r,d));return f}]},!!d(function(){var e=/(?:)/;var t=e.exec;e.exec=function(){return t.apply(this,arguments)};var a="ab".split(e);return a.length!==2||a[0]!=="a"||a[1]!=="b"}),qr);var si=Object.assign,oi=Object.defineProperty,li=C([].concat),ci=!si||d(function(){if(p&&si({b:1},si(oi({},"a",{enumerable:true,get:function(){oi(this,"b",{value:3,enumerable:false})}}),{b:2})).b!==1)return true;var e={};var t={};var a=Symbol();var r="abcdefghijklmnopqrst";e[a]=7;r.split("").forEach(function(e){t[e]=e});return si({},e)[a]!=7||la(si({},t)).join("")!=r})?function e(t,a){var r=de(t);var i=arguments.length;var n=1;var s=Pt.f;var o=g.f;while(i>n){var l=x(arguments[n++]);var c=s?li(la(l),s(l)):la(l);var d=c.length;var u=0;var f;while(d>u){f=c[u++];if(!p||y(o,l,f))r[f]=l[f]}}return r}:si;function di(e){var t=e.parentNode;if(!t||t.nodeName==="HTML")return false;if(Xr(e,"position")==="fixed")return true;return di(t)}function ui(e,t){var a=document.body;var r=document.documentElement;var i=window.pageYOffset||r.scrollTop||a.scrollTop;var n=window.pageXOffset||r.scrollLeft||a.scrollLeft;t=t||a;var s=e.getBoundingClientRect();var o=t.getBoundingClientRect();var l=Xr(t,"position");var c={width:s.width,height:s.height};if(t.tagName.toLowerCase()!=="body"&&l==="relative"||l==="sticky")return Object.assign(c,{top:s.top-o.top,left:s.left-o.left});else if(di(e))return Object.assign(c,{top:s.top,left:s.left});else return Object.assign(c,{top:s.top+i,left:s.left+n})}Ht({target:"Object",stat:true,forced:Object.assign!==ci},{assign:ci});var fi=Math.floor,pi=C("".charAt),hi=C("".replace),mi=C("".slice),gi=/\$([$&'`]|\d{1,2}|<[^>]*>)/g,vi=/\$([$&'`]|\d{1,2})/g,bi=function(n,s,o,l,c,e){var d=o+n.length;var u=l.length;var t=vi;if(c!==undefined){c=de(c);t=gi}return hi(e,t,function(e,t){var a;switch(pi(t,0)){case"$":return"$";case"&":return n;case"`":return mi(s,0,o);case"'":return mi(s,d);case"<":a=c[mi(t,1,-1)];break;default:var r=+t;if(r===0)return e;if(r>u){var i=fi(r/10);if(i===0)return e;if(i<=u)return l[i-1]===undefined?pi(t,1):l[i-1]+pi(t,1);return e}a=l[r-1]}return a===undefined?"":a})},yi=ke("replace"),wi=Math.max,ki=Math.min,Si=C([].concat),Ci=C([].push),_i=C("".indexOf),Ai=C("".slice),Ti=function(e){return e===undefined?e:String(e)},Ii=function(){return"a".replace(/./,"$0")==="$0"}(),Ei=function(){if(/./[yi])return/./[yi]("a","$0")==="";return false}(),xi;function ji(e,t){if(e instanceof SVGElement){var a=e.getAttribute("class")||"";e.setAttribute("class",a.replace(t,"").replace(/^\s+|\s+$/g,""))}else e.className=e.className.replace(t,"").replace(/^\s+|\s+$/g,"")}function Di(e,t){var a="";if(e.style.cssText)a+=e.style.cssText;if(typeof t==="string")a+=t;else for(var r in t)a+="".concat(r,":").concat(t[r],";");e.style.cssText=a}function Oi(e){if(e){if(!this._introItems[this._currentStep])return;var t=this._introItems[this._currentStep];var a=ui(t.element,this._targetElement);var r=this._options.helperElementPadding;if(di(t.element))Jr(e,"introjs-fixedTooltip");else ji(e,"introjs-fixedTooltip");if(t.position==="floating")r=0;Di(e,{width:"".concat(a.width+r,"px"),height:"".concat(a.height+r,"px"),top:"".concat(a.top-r/2,"px"),left:"".concat(a.left-r/2,"px")})}}Za("replace",function(e,k,S){var C=Ei?"$":"$0";return[function e(t,a){var r=D(this);var i=t==undefined?undefined:ee(t,yi);return i?y(i,t,r,a):y(k,aa(r),t,a)},function(e,t){var a=Re(this);var r=aa(e);if(typeof t=="string"&&_i(t,C)===-1&&_i(t,"$<")===-1){var i=S(k,a,r,t);if(i.done)return i.value}var n=N(t);if(!n)t=aa(t);var s=a.global;if(s){var o=a.unicode;a.lastIndex=0}var l=[];while(true){var c=Ja(a,r);if(c===null)break;Ci(l,c);if(!s)break;var d=aa(c[0]);if(d==="")a.lastIndex=Ya(r,St(a.lastIndex),o)}var u="";var f=0;for(var p=0;p<l.length;p++){c=l[p];var h=aa(c[0]);var m=wi(ki(vt(c.index),r.length),0);var g=[];for(var v=1;v<c.length;v++)Ci(g,Ti(c[v]));var b=c.groups;if(n){var y=Si([h],g,m,r);if(b!==undefined)Ci(y,b);var w=aa(Rr(t,undefined,y))}else w=bi(h,r,m,g,b,t);if(m>=f){u+=Ai(r,f,m)+w;f=m+h.length}}return u+Ai(r,f)}]},!!d(function(){var e=/./;e.exec=function(){var e=[];e.groups={a:"7"};return e};return"".replace(e,"$<a>")!=="7"})||!Ii||Ei);var Ni=ke("unscopables"),Pi=Array.prototype;if(Pi[Ni]==undefined)Le.f(Pi,Ni,{configurable:true,value:Sa(null)});var Ri=function(e){Pi[Ni][e]=true},$i=At.includes;Ht({target:"Array",proto:true},{includes:function e(t){return $i(this,t,arguments.length>1?arguments[1]:undefined)}}),Ri("includes");var Mi=hr("slice"),zi=ke("species"),Li=f.Array,Bi=Math.max;Ht({target:"Array",proto:true,forced:!Mi},{slice:function e(t,a){var r=O(this);var i=Ct(r);var n=wt(t,i);var s=wt(a===undefined?i:a,i);var o,l,c;if(Xa(r)){o=r.constructor;if(lr(o)&&(o===Li||Xa(o.prototype)))o=undefined;else if(P(o)){o=o[zi];if(o===null)o=undefined}if(o===Li||o===undefined)return Zr(r,n,s)}l=new(o===undefined?Li:o)(Bi(s-n,0));for(c=0;n<s;n++,c++)if(n in r)Qa(l,c,r[n]);l.length=c;return l}});var Fi=f.TypeError,Zi=function(e){if(Mr(e))throw Fi("The method doesn't accept regular expressions");return e},qi=ke("match"),Wi=function(t){var a=/./;try{"/./"[t](a)}catch(e){try{a[qi]=false;return"/./"[t](a)}catch(e){}}return false},Gi=C("".indexOf);Ht({target:"String",proto:true,forced:!Wi("includes")},{includes:function e(t){return!!~Gi(aa(D(this)),aa(Zi(t)),arguments.length>1?arguments[1]:undefined)}});var Hi=function(e,t){var a=[][e];return!!a&&d(function(){a.call(null,t||function(){throw 1},1)})},Ui=C([].join),Vi=x!=Object,Yi=Hi("join",",");Ht({target:"Array",proto:true,forced:Vi||!Yi},{join:function e(t){return Ui(O(this),t===undefined?",":t)}});var Ki=C(C.bind),Ji=function(e,t){Q(e);return t===undefined?e:Ki?Ki(e,t):function(){return e.apply(t,arguments)}},Xi=C([].push),Qi=function(p){var h=p==1;var m=p==2;var g=p==3;var v=p==4;var b=p==6;var y=p==7;var w=p==5||b;return function(e,t,a,r){var i=de(e);var n=x(i);var s=Ji(t,a);var o=Ct(n);var l=0;var c=r||fr;var d=h?c(e,o):m||y?c(e,0):undefined;var u,f;for(;o>l;l++)if(w||l in n){u=n[l];f=s(u,l,i);if(p)if(h)d[l]=f;else if(f)switch(p){case 3:return true;case 5:return u;case 6:return l;case 2:Xi(d,u)}else switch(p){case 4:return false;case 7:Xi(d,u)}}return b?-1:g||v?v:d}},en,tn={forEach:Qi(0),map:Qi(1),filter:Qi(2),some:Qi(3),every:Qi(4),find:Qi(5),findIndex:Qi(6),filterReject:Qi(7)}.filter,an;function rn(e,t,a,r,i){if(e.left+t+a.width>r.width){i.style.left="".concat(r.width-a.width-e.left,"px");return false}i.style.left="".concat(t,"px");return true}function nn(e,t,a,r){if(e.left+e.width-t-a.width<0){r.style.left="".concat(-e.left,"px");return false}r.style.right="".concat(t,"px");return true}Ht({target:"Array",proto:true,forced:!hr("filter")},{filter:function e(t){return tn(this,t,arguments.length>1?arguments[1]:undefined)}});var sn=hr("splice"),on=f.TypeError,ln=Math.max,cn=Math.min,dn=9007199254740991,un="Maximum allowed length exceeded";function fn(e,t){if(e.includes(t))e.splice(e.indexOf(t),1)}function pn(e,t,a,r){var i=a.width;var n=t/2;var s=Math.min(i,window.screen.width);var o=["-left-aligned","-middle-aligned","-right-aligned"];var l="";if(s-e<t)fn(o,"-left-aligned");if(e<n||s-e<n)fn(o,"-middle-aligned");if(e<t)fn(o,"-right-aligned");if(o.length)if(o.includes(r))l=r;else l=o[0];else l="-middle-aligned";return l}function hn(e,t,a){var r=this._options.positionPrecedence.slice();var i=ai();var n=ui(t).height+10;var s=ui(t).width+20;var o=e.getBoundingClientRect();var l="floating";if(o.bottom+n>i.height)fn(r,"bottom");if(o.top-n<0)fn(r,"top");if(o.right+s>i.width)fn(r,"right");if(o.left-s<0)fn(r,"left");var c=function(e){var t=e.indexOf("-");if(t!==-1)return e.substr(t);return""}(a||"");if(a)a=a.split("-")[0];if(r.length)if(r.includes(a))l=a;else l=r[0];if(["top","bottom"].includes(l))l+=pn(o.left,s,i,c);return l}function mn(e,t,a,r){var i="";var n;var s;var o;var l;var c;r=r||false;t.style.top=null;t.style.right=null;t.style.bottom=null;t.style.left=null;t.style.marginLeft=null;t.style.marginTop=null;a.style.display="inherit";if(!this._introItems[this._currentStep])return;n=this._introItems[this._currentStep];if(typeof n.tooltipClass==="string")i=n.tooltipClass;else i=this._options.tooltipClass;t.className=["introjs-tooltip",i].filter(Boolean).join(" ");t.setAttribute("role","dialog");c=this._introItems[this._currentStep].position;if(c!=="floating"&&this._options.autoPosition)c=hn.call(this,e,t,c);var d;o=ui(e);s=ui(t);l=ai();Jr(t,"introjs-".concat(c));switch(c){case"top-right-aligned":a.className="introjs-arrow bottom-right";var u=0;nn(o,u,s,t);t.style.bottom="".concat(o.height+20,"px");break;case"top-middle-aligned":a.className="introjs-arrow bottom-middle";var f=o.width/2-s.width/2;if(r)f+=5;if(nn(o,f,s,t)){t.style.right=null;rn(o,f,s,l,t)}t.style.bottom="".concat(o.height+20,"px");break;case"top-left-aligned":case"top":a.className="introjs-arrow bottom";d=r?0:15;rn(o,d,s,l,t);t.style.bottom="".concat(o.height+20,"px");break;case"right":t.style.left="".concat(o.width+20,"px");if(o.top+s.height>l.height){a.className="introjs-arrow left-bottom";t.style.top="-".concat(s.height-o.height-20,"px")}else a.className="introjs-arrow left";break;case"left":if(!r&&this._options.showStepNumbers===true)t.style.top="15px";if(o.top+s.height>l.height){t.style.top="-".concat(s.height-o.height-20,"px");a.className="introjs-arrow right-bottom"}else a.className="introjs-arrow right";t.style.right="".concat(o.width+20,"px");break;case"floating":a.style.display="none";t.style.left="50%";t.style.top="50%";t.style.marginLeft="-".concat(s.width/2,"px");t.style.marginTop="-".concat(s.height/2,"px");break;case"bottom-right-aligned":a.className="introjs-arrow top-right";u=0;nn(o,u,s,t);t.style.top="".concat(o.height+20,"px");break;case"bottom-middle-aligned":a.className="introjs-arrow top-middle";f=o.width/2-s.width/2;if(r)f+=5;if(nn(o,f,s,t)){t.style.right=null;rn(o,f,s,l,t)}t.style.top="".concat(o.height+20,"px");break;default:a.className="introjs-arrow top";d=0;rn(o,d,s,l,t);t.style.top="".concat(o.height+20,"px")}}function gn(){var e=document.querySelectorAll(".introjs-showElement");c(e,function(e){ji(e,/introjs-[a-zA-Z]+/g)})}function vn(e,t){var a=document.createElement(e);t=t||{};var r=/^(?:role|data-|aria-)/;for(var i in t){var n=t[i];if(i==="style")Di(a,n);else if(i.match(r))a.setAttribute(i,n);else a[i]=n}return a}function bn(e,t,a){if(a){var r=t.style.opacity||"1";Di(t,{opacity:"0"});window.setTimeout(function(){Di(t,{opacity:r})},10)}e.appendChild(t)}function yn(){var e=parseInt(this._currentStep+1,10);return e/this._introItems.length*100}function wn(){var e=document.querySelector(".introjs-disableInteraction");if(e===null){e=vn("div",{className:"introjs-disableInteraction"});this._targetElement.appendChild(e)}Oi.call(this,e)}function kn(n){var t=this;var e=vn("div",{className:"introjs-bullets"});if(this._options.showBullets===false)e.style.display="none";var s=vn("ul");s.setAttribute("role","tablist");var o=function e(){t.goToStep(this.getAttribute("data-stepnumber"))};c(this._introItems,function(e,t){var a=e.step;var r=vn("li");var i=vn("a");r.setAttribute("role","presentation");i.setAttribute("role","tab");i.onclick=o;if(t===n.step-1)i.className="active";ni(i);i.innerHTML="&nbsp;";i.setAttribute("data-stepnumber",a);r.appendChild(i);s.appendChild(r)});e.appendChild(s);return e}function Sn(e,t){if(this._options.showBullets){var a=document.querySelector(".introjs-bullets");a.parentNode.replaceChild(kn.call(this,t),a)}}function Cn(e,t){if(this._options.showBullets){e.querySelector(".introjs-bullets li > a.active").className="";e.querySelector('.introjs-bullets li > a[data-stepnumber="'.concat(t.step,'"]')).className="active"}}function _n(){var e=vn("div");e.className="introjs-progress";if(this._options.showProgress===false)e.style.display="none";var t=vn("div",{className:"introjs-progressbar"});if(this._options.progressBarAdditionalClass)t.className+=" "+this._options.progressBarAdditionalClass;t.setAttribute("role","progress");t.setAttribute("aria-valuemin",0);t.setAttribute("aria-valuemax",100);t.setAttribute("aria-valuenow",yn.call(this));t.style.cssText="width:".concat(yn.call(this),"%;");e.appendChild(t);return e}function An(e){e.querySelector(".introjs-progress .introjs-progressbar").style.cssText="width:".concat(yn.call(this),"%;");e.querySelector(".introjs-progress .introjs-progressbar").setAttribute("aria-valuenow",yn.call(this))}function Tn(e){var t=this;if(typeof this._introChangeCallback!=="undefined")this._introChangeCallback.call(this,e.element);var a=this;var r=document.querySelector(".introjs-helperLayer");var i=document.querySelector(".introjs-tooltipReferenceLayer");var n="introjs-helperLayer";var s;var o;var l;if(typeof e.highlightClass==="string")n+=" ".concat(e.highlightClass);if(typeof this._options.highlightClass==="string")n+=" ".concat(this._options.highlightClass);if(r!==null&&i!==null){var c=i.querySelector(".introjs-helperNumberLayer");var d=i.querySelector(".introjs-tooltiptext");var u=i.querySelector(".introjs-tooltip-title");var f=i.querySelector(".introjs-arrow");var p=i.querySelector(".introjs-tooltip");l=i.querySelector(".introjs-skipbutton");o=i.querySelector(".introjs-prevbutton");s=i.querySelector(".introjs-nextbutton");r.className=n;p.style.opacity=0;p.style.display="none";ti.call(a,e);Oi.call(a,r);Oi.call(a,i);gn();if(a._lastShowElementTimer)window.clearTimeout(a._lastShowElementTimer);a._lastShowElementTimer=window.setTimeout(function(){if(c!==null)c.innerHTML="".concat(e.step," of ").concat(t._introItems.length);d.innerHTML=e.intro;u.innerHTML=e.title;p.style.display="block";mn.call(a,e.element,p,f);Cn.call(a,i,e);An.call(a,i);p.style.opacity=1;if(typeof s!=="undefined"&&s!==null&&/introjs-donebutton/gi.test(s.className))s.focus();else if(typeof s!=="undefined"&&s!==null)s.focus();ii.call(a,e.scrollTo,e,d)},350)}else{var h=vn("div",{className:n});var m=vn("div",{className:"introjs-tooltipReferenceLayer"});var g=vn("div",{className:"introjs-arrow"});var v=vn("div",{className:"introjs-tooltip"});var b=vn("div",{className:"introjs-tooltiptext"});var y=vn("div",{className:"introjs-tooltip-header"});var w=vn("h1",{className:"introjs-tooltip-title"});var k=vn("div");Di(h,{"box-shadow":"0 0 1px 2px rgba(33, 33, 33, 0.8), rgba(33, 33, 33, ".concat(a._options.overlayOpacity.toString(),") 0 0 0 5000px")});ti.call(a,e);Oi.call(a,h);Oi.call(a,m);bn(this._targetElement,h,true);bn(this._targetElement,m);b.innerHTML=e.intro;w.innerHTML=e.title;k.className="introjs-tooltipbuttons";if(this._options.showButtons===false)k.style.display="none";y.appendChild(w);v.appendChild(y);v.appendChild(b);v.appendChild(kn.call(this,e));v.appendChild(_n.call(this));var S=vn("div");if(this._options.showStepNumbers===true){S.className="introjs-helperNumberLayer";S.innerHTML="".concat(e.step," of ").concat(this._introItems.length);v.appendChild(S)}v.appendChild(g);m.appendChild(v);s=vn("a");s.onclick=function(){if(a._introItems.length-1!==a._currentStep)xn.call(a);else if(/introjs-donebutton/gi.test(s.className)){if(typeof a._introCompleteCallback==="function")a._introCompleteCallback.call(a,a._currentStep,"done");bs.call(a,a._targetElement)}};ni(s);s.innerHTML=this._options.nextLabel;o=vn("a");o.onclick=function(){if(a._currentStep!==0)jn.call(a)};ni(o);o.innerHTML=this._options.prevLabel;l=vn("a",{className:"introjs-skipbutton"});ni(l);l.innerHTML=this._options.skipLabel;l.onclick=function(){if(a._introItems.length-1===a._currentStep&&typeof a._introCompleteCallback==="function")a._introCompleteCallback.call(a,a._currentStep,"skip");if(typeof a._introSkipCallback==="function")a._introSkipCallback.call(a);bs.call(a,a._targetElement)};y.appendChild(l);if(this._introItems.length>1)k.appendChild(o);k.appendChild(s);v.appendChild(k);mn.call(a,e.element,v,g);ii.call(this,e.scrollTo,e,v)}var C=a._targetElement.querySelector(".introjs-disableInteraction");if(C)C.parentNode.removeChild(C);if(e.disableInteraction)wn.call(a);if(this._currentStep===0&&this._introItems.length>1){if(typeof s!=="undefined"&&s!==null){s.className="".concat(this._options.buttonClass," introjs-nextbutton");s.innerHTML=this._options.nextLabel}if(this._options.hidePrev===true){if(typeof o!=="undefined"&&o!==null)o.className="".concat(this._options.buttonClass," introjs-prevbutton introjs-hidden");if(typeof s!=="undefined"&&s!==null)Jr(s,"introjs-fullbutton")}else if(typeof o!=="undefined"&&o!==null)o.className="".concat(this._options.buttonClass," introjs-prevbutton introjs-disabled")}else if(this._introItems.length-1===this._currentStep||this._introItems.length===1){if(typeof o!=="undefined"&&o!==null)o.className="".concat(this._options.buttonClass," introjs-prevbutton");if(this._options.hideNext===true){if(typeof s!=="undefined"&&s!==null)s.className="".concat(this._options.buttonClass," introjs-nextbutton introjs-hidden");if(typeof o!=="undefined"&&o!==null)Jr(o,"introjs-fullbutton")}else if(typeof s!=="undefined"&&s!==null)if(this._options.nextToDone===true){s.innerHTML=this._options.doneLabel;Jr(s,"".concat(this._options.buttonClass," introjs-nextbutton introjs-donebutton"))}else s.className="".concat(this._options.buttonClass," introjs-nextbutton introjs-disabled")}else{if(typeof o!=="undefined"&&o!==null)o.className="".concat(this._options.buttonClass," introjs-prevbutton");if(typeof s!=="undefined"&&s!==null){s.className="".concat(this._options.buttonClass," introjs-nextbutton");s.innerHTML=this._options.nextLabel}}if(typeof o!=="undefined"&&o!==null)o.setAttribute("role","button");if(typeof s!=="undefined"&&s!==null)s.setAttribute("role","button");if(typeof l!=="undefined"&&l!==null)l.setAttribute("role","button");if(typeof s!=="undefined"&&s!==null)s.focus();Qr(e);if(typeof this._introAfterChangeCallback!=="undefined")this._introAfterChangeCallback.call(this,e.element)}function In(e){this._currentStep=e-2;if(typeof this._introItems!=="undefined")xn.call(this)}function En(e){this._currentStepNumber=e;if(typeof this._introItems!=="undefined")xn.call(this)}function xn(){var r=this;this._direction="forward";if(typeof this._currentStepNumber!=="undefined")c(this._introItems,function(e,t){var a=e.step;if(a===r._currentStepNumber){r._currentStep=t-1;r._currentStepNumber=undefined}});if(typeof this._currentStep==="undefined")this._currentStep=0;else++this._currentStep;var e=this._introItems[this._currentStep];var t=true;if(typeof this._introBeforeChangeCallback!=="undefined")t=this._introBeforeChangeCallback.call(this,e&&e.element);if(t===false){--this._currentStep;return false}if(this._introItems.length<=this._currentStep){if(typeof this._introCompleteCallback==="function")this._introCompleteCallback.call(this,this._currentStep,"end");bs.call(this,this._targetElement);return}Tn.call(this,e)}function jn(){this._direction="backward";if(this._currentStep===0)return false;--this._currentStep;var e=this._introItems[this._currentStep];var t=true;if(typeof this._introBeforeChangeCallback!=="undefined")t=this._introBeforeChangeCallback.call(this,e&&e.element);if(t===false){++this._currentStep;return false}Tn.call(this,e)}function Dn(){return this._currentStep}function On(e){var t=e.code===undefined?e.which:e.code;if(t===null)t=e.charCode===null?e.keyCode:e.charCode;if((t==="Escape"||t===27)&&this._options.exitOnEsc===true)bs.call(this,this._targetElement);else if(t==="ArrowLeft"||t===37)jn.call(this);else if(t==="ArrowRight"||t===39)xn.call(this);else if(t==="Enter"||t==="NumpadEnter"||t===13){var a=e.target||e.srcElement;if(a&&a.className.match("introjs-prevbutton"))jn.call(this);else if(a&&a.className.match("introjs-skipbutton")){if(this._introItems.length-1===this._currentStep&&typeof this._introCompleteCallback==="function")this._introCompleteCallback.call(this,this._currentStep,"skip");bs.call(this,this._targetElement)}else if(a&&a.getAttribute("data-stepnumber"))a.click();else xn.call(this);if(e.preventDefault)e.preventDefault();else e.returnValue=false}}function Nn(e){if(e===null||i(e)!=="object"||typeof e.nodeType!=="undefined")return e;var t={};for(var a in e)if(typeof window.jQuery!=="undefined"&&e[a]instanceof window.jQuery)t[a]=e[a];else t[a]=Nn(e[a]);return t}function Pn(r,i){var n=this;var s;return function(){for(var e=arguments.length,t=new Array(e),a=0;a<e;a++)t[a]=arguments[a];clearTimeout(s);s=setTimeout(function(){r.apply(n,t)},i)}}function Rn(e){var t=document.querySelector(".introjs-hints");return t?t.querySelectorAll(e):[]}function $n(e){var t=Rn('.introjs-hint[data-step="'.concat(e,'"]'))[0];Gn.call(this);if(t)Jr(t,"introjs-hidehint");if(typeof this._hintCloseCallback!=="undefined")this._hintCloseCallback.call(this,e)}function Mn(){var t=this;var e=Rn(".introjs-hint");c(e,function(e){$n.call(t,e.getAttribute("data-step"))})}function zn(){var t=this;var e=Rn(".introjs-hint");if(e&&e.length)c(e,function(e){Ln.call(t,e.getAttribute("data-step"))});else Hn.call(this,this._targetElement)}function Ln(e){var t=Rn('.introjs-hint[data-step="'.concat(e,'"]'))[0];if(t)ji(t,/introjs-hidehint/g)}function Bn(){var t=this;var e=Rn(".introjs-hint");c(e,function(e){Fn.call(t,e.getAttribute("data-step"))});l.off(document,"click",Gn,this,false);l.off(window,"resize",Un,this,true);if(this._hintsAutoRefreshFunction)l.off(window,"scroll",this._hintsAutoRefreshFunction,this,true)}function Fn(e){var t=Rn('.introjs-hint[data-step="'.concat(e,'"]'))[0];if(t)t.parentNode.removeChild(t)}function Zn(){var n=this;var r=this;var s=document.querySelector(".introjs-hints");if(s===null)s=vn("div",{className:"introjs-hints"});var o=function e(a){return function(e){var t=e?e:window.event;if(t.stopPropagation)t.stopPropagation();if(t.cancelBubble!==null)t.cancelBubble=true;Wn.call(r,a)}};c(this._introItems,function(e,t){if(document.querySelector('.introjs-hint[data-step="'.concat(t,'"]')))return;var a=vn("a",{className:"introjs-hint"});ni(a);a.onclick=o(t);if(!e.hintAnimation)Jr(a,"introjs-hint-no-anim");if(di(e.element))Jr(a,"introjs-fixedhint");var r=vn("div",{className:"introjs-hint-dot"});var i=vn("div",{className:"introjs-hint-pulse"});a.appendChild(r);a.appendChild(i);a.setAttribute("data-step",t);e.targetElement=e.element;e.element=a;qn.call(n,e.hintPosition,a,e.targetElement);s.appendChild(a)});document.body.appendChild(s);if(typeof this._hintsAddedCallback!=="undefined")this._hintsAddedCallback.call(this);if(this._options.hintAutoRefreshInterval>=0){this._hintsAutoRefreshFunction=Pn(function(){return Un.call(n)},this._options.hintAutoRefreshInterval);l.on(window,"scroll",this._hintsAutoRefreshFunction,this,true)}}function qn(e,t,a){var r=t.style;var i=ui.call(this,a);var n=20;var s=20;switch(e){default:case"top-left":r.left="".concat(i.left,"px");r.top="".concat(i.top,"px");break;case"top-right":r.left="".concat(i.left+i.width-n,"px");r.top="".concat(i.top,"px");break;case"bottom-left":r.left="".concat(i.left,"px");r.top="".concat(i.top+i.height-s,"px");break;case"bottom-right":r.left="".concat(i.left+i.width-n,"px");r.top="".concat(i.top+i.height-s,"px");break;case"middle-left":r.left="".concat(i.left,"px");r.top="".concat(i.top+(i.height-s)/2,"px");break;case"middle-right":r.left="".concat(i.left+i.width-n,"px");r.top="".concat(i.top+(i.height-s)/2,"px");break;case"middle-middle":r.left="".concat(i.left+(i.width-n)/2,"px");r.top="".concat(i.top+(i.height-s)/2,"px");break;case"bottom-middle":r.left="".concat(i.left+(i.width-n)/2,"px");r.top="".concat(i.top+i.height-s,"px");break;case"top-middle":r.left="".concat(i.left+(i.width-n)/2,"px");r.top="".concat(i.top,"px");break}}function Wn(e){var t=document.querySelector('.introjs-hint[data-step="'.concat(e,'"]'));var a=this._introItems[e];if(typeof this._hintClickCallback!=="undefined")this._hintClickCallback.call(this,t,a,e);var r=Gn.call(this);if(parseInt(r,10)===e)return;var i=vn("div",{className:"introjs-tooltip"});var n=vn("div");var s=vn("div");var o=vn("div");i.onclick=function(e){if(e.stopPropagation)e.stopPropagation();else e.cancelBubble=true};n.className="introjs-tooltiptext";var l=vn("p");l.innerHTML=a.hint;n.appendChild(l);if(this._options.hintShowButton){var c=vn("a");c.className=this._options.buttonClass;c.setAttribute("role","button");c.innerHTML=this._options.hintButtonLabel;c.onclick=$n.bind(this,e);n.appendChild(c)}s.className="introjs-arrow";i.appendChild(s);i.appendChild(n);this._currentStep=t.getAttribute("data-step");o.className="introjs-tooltipReferenceLayer introjs-hintReference";o.setAttribute("data-step",t.getAttribute("data-step"));Oi.call(this,o);o.appendChild(i);document.body.appendChild(o);mn.call(this,t,i,s,true)}function Gn(){var e=document.querySelector(".introjs-hintReference");if(e){var t=e.getAttribute("data-step");e.parentNode.removeChild(e);return t}}function Hn(e){var a=this;this._introItems=[];if(this._options.hints)c(this._options.hints,function(e){var t=Nn(e);if(typeof t.element==="string")t.element=document.querySelector(t.element);t.hintPosition=t.hintPosition||a._options.hintPosition;t.hintAnimation=t.hintAnimation||a._options.hintAnimation;if(t.element!==null)a._introItems.push(t)});else{var t=e.querySelectorAll("*[data-hint]");if(!t||!t.length)return false;c(t,function(e){var t=e.getAttribute("data-hintanimation");if(t)t=t==="true";else t=a._options.hintAnimation;a._introItems.push({element:e,hint:e.getAttribute("data-hint"),hintPosition:e.getAttribute("data-hintposition")||a._options.hintPosition,hintAnimation:t,tooltipClass:e.getAttribute("data-tooltipclass"),position:e.getAttribute("data-position")||a._options.tooltipPosition})})}Zn.call(this);l.on(document,"click",Gn,this,false);l.on(window,"resize",Un,this,true)}function Un(){var i=this;c(this._introItems,function(e){var t=e.targetElement,a=e.hintPosition,r=e.element;if(typeof t==="undefined")return;qn.call(i,a,r,t)})}Ht({target:"Array",proto:true,forced:!sn},{splice:function e(t,a){var r=de(this);var i=Ct(r);var n=wt(t,i);var s=arguments.length;var o,l,c,d,u,f;if(s===0)o=l=0;else if(s===1){o=0;l=i-n}else{o=s-2;l=cn(ln(vt(a),0),i-n)}if(i+o-l>dn)throw on(un);c=fr(r,l);for(d=0;d<l;d++){u=n+d;if(u in r)Qa(c,d,r[u])}c.length=l;if(o<l){for(d=n;d<i-l;d++){u=d+l;f=d+o;if(u in r)r[f]=r[u];else delete r[f]}for(d=i;d>i-l+o;d--)delete r[d-1]}else if(o>l)for(d=i-l;d>n;d--){u=d+l-1;f=d+o-1;if(u in r)r[f]=r[u];else delete r[f]}for(d=0;d<o;d++)r[d+n]=arguments[d+2];r.length=i-l+o;return c}});var Vn=Math.floor,Yn=function(e,t){var a=e.length;var r=Vn(a/2);return a<8?Kn(e,t):Jn(e,Yn(Zr(e,0,r),t),Yn(Zr(e,r),t),t)},Kn=function(e,t){var a=e.length;var r=1;var i,n;while(r<a){n=r;i=e[r];while(n&&t(e[n-1],i)>0)e[n]=e[--n];if(n!==r++)e[n]=i}return e},Jn=function(e,t,a,r){var i=t.length;var n=a.length;var s=0;var o=0;while(s<i||o<n)e[s+o]=s<i&&o<n?r(t[s],a[o])<=0?t[s++]:a[o++]:s<i?t[s++]:a[o++];return e},Xn=Yn,Qn=z.match(/firefox\/(\d+)/i),es=!!Qn&&+Qn[1],ts=/MSIE|Trident/.test(z),as=z.match(/AppleWebKit\/(\d+)\./),rs=!!as&&+as[1],is=[],ns=C(is.sort),ss=C(is.push),os=d(function(){is.sort(undefined)}),ls=d(function(){is.sort(null)}),cs=Hi("sort"),ds=!d(function(){if(G)return G<70;if(es&&es>3)return;if(ts)return true;if(rs)return rs<603;var e="";var t,a,r,i;for(t=65;t<76;t++){a=String.fromCharCode(t);switch(t){case 66:case 69:case 70:case 72:r=3;break;case 68:case 71:r=4;break;default:r=2}for(i=0;i<47;i++)is.push({k:a+i,v:r})}is.sort(function(e,t){return t.v-e.v});for(i=0;i<is.length;i++){a=is[i].k.charAt(0);if(e.charAt(e.length-1)!==a)e+=a}return e!=="DGBEFHACIJK"}),us,fs=function(a){return function(e,t){if(t===undefined)return-1;if(e===undefined)return 1;if(a!==undefined)return+a(e,t)||0;return aa(e)>aa(t)?1:-1}},ps;function hs(e){var r=this;var t=e.querySelectorAll("*[data-intro]");var i=[];if(this._options.steps)c(this._options.steps,function(e){var t=Nn(e);t.step=i.length+1;t.title=t.title||"";if(typeof t.element==="string")t.element=document.querySelector(t.element);if(typeof t.element==="undefined"||t.element===null){var a=document.querySelector(".introjsFloatingElement");if(a===null){a=vn("div",{className:"introjsFloatingElement"});document.body.appendChild(a)}t.element=a;t.position="floating"}t.position=t.position||r._options.tooltipPosition;t.scrollTo=t.scrollTo||r._options.scrollTo;if(typeof t.disableInteraction==="undefined")t.disableInteraction=r._options.disableInteraction;if(t.element!==null)i.push(t)});else{var a=t.length;var n;if(a<1)return[];c(t,function(e){if(r._options.group&&e.getAttribute("data-intro-group")!==r._options.group)return;if(e.style.display==="none")return;var t=parseInt(e.getAttribute("data-step"),10);if(e.hasAttribute("data-disable-interaction"))n=!!e.getAttribute("data-disable-interaction");else n=r._options.disableInteraction;if(t>0)i[t-1]={element:e,title:e.getAttribute("data-title")||"",intro:e.getAttribute("data-intro"),step:parseInt(e.getAttribute("data-step"),10),tooltipClass:e.getAttribute("data-tooltipclass"),highlightClass:e.getAttribute("data-highlightclass"),position:e.getAttribute("data-position")||r._options.tooltipPosition,scrollTo:e.getAttribute("data-scrollto")||r._options.scrollTo,disableInteraction:n}});var s=0;c(t,function(e){if(r._options.group&&e.getAttribute("data-intro-group")!==r._options.group)return;if(e.getAttribute("data-step")===null){while(true)if(typeof i[s]==="undefined")break;else s++;if(e.hasAttribute("data-disable-interaction"))n=!!e.getAttribute("data-disable-interaction");else n=r._options.disableInteraction;i[s]={element:e,title:e.getAttribute("data-title")||"",intro:e.getAttribute("data-intro"),step:s+1,tooltipClass:e.getAttribute("data-tooltipclass"),highlightClass:e.getAttribute("data-highlightclass"),position:e.getAttribute("data-position")||r._options.tooltipPosition,scrollTo:e.getAttribute("data-scrollto")||r._options.scrollTo,disableInteraction:n}}})}var o=[];for(var l=0;l<i.length;l++)if(i[l])o.push(i[l]);i=o;i.sort(function(e,t){return e.step-t.step});return i}function ms(e){var t=document.querySelector(".introjs-tooltipReferenceLayer");var a=document.querySelector(".introjs-helperLayer");var r=document.querySelector(".introjs-disableInteraction");Oi.call(this,a);Oi.call(this,t);Oi.call(this,r);if(e){this._introItems=hs.call(this,this._targetElement);Sn.call(this,t,this._introItems[this._currentStep]);An.call(this,t)}if(this._currentStep!==undefined&&this._currentStep!==null){var i=document.querySelector(".introjs-arrow");var n=document.querySelector(".introjs-tooltip");if(n&&i)mn.call(this,this._introItems[this._currentStep].element,n,i)}Un.call(this);return this}function gs(){ms.call(this)}function vs(e,t){if(!e||!e.parentElement)return;var a=e.parentElement;if(t){Di(e,{opacity:"0"});window.setTimeout(function(){try{a.removeChild(e)}catch(e){}},500)}else a.removeChild(e)}function bs(e,t){var a=true;if(this._introBeforeExitCallback!==undefined)a=this._introBeforeExitCallback.call(this);if(!t&&a===false)return;var r=e.querySelectorAll(".introjs-overlay");if(r&&r.length)c(r,function(e){return vs(e)});var i=e.querySelector(".introjs-helperLayer");vs(i,true);var n=e.querySelector(".introjs-tooltipReferenceLayer");vs(n);var s=e.querySelector(".introjs-disableInteraction");vs(s);var o=document.querySelector(".introjsFloatingElement");vs(o);gn();l.off(window,"keydown",On,this,true);l.off(window,"resize",gs,this,true);if(this._introExitCallback!==undefined)this._introExitCallback.call(this);this._currentStep=undefined}function ys(e){var t=this;var a=vn("div",{className:"introjs-overlay"});Di(a,{top:0,bottom:0,left:0,right:0,position:"fixed"});e.appendChild(a);if(this._options.exitOnOverlayClick===true){Di(a,{cursor:"pointer"});a.onclick=function(){bs.call(t,e)}}return true}function ws(e){if(this._introStartCallback!==undefined)this._introStartCallback.call(this,e);var t=hs.call(this,e);if(t.length===0)return false;this._introItems=t;if(ys.call(this,e)){xn.call(this);if(this._options.keyboardNavigation)l.on(window,"keydown",On,this,true);l.on(window,"resize",gs,this,true)}return false}function ks(e){this._targetElement=e;this._introItems=[];this._options={nextLabel:"Next",prevLabel:"Back",skipLabel:"×",doneLabel:"Done",hidePrev:false,hideNext:false,nextToDone:true,tooltipPosition:"bottom",tooltipClass:"",group:"",highlightClass:"",exitOnEsc:true,exitOnOverlayClick:true,showStepNumbers:false,keyboardNavigation:true,showButtons:true,showBullets:true,showProgress:false,scrollToElement:true,scrollTo:"element",scrollPadding:30,overlayOpacity:.5,autoPosition:true,positionPrecedence:["bottom","top","right","left"],disableInteraction:false,helperElementPadding:10,hintPosition:"top-middle",hintButtonLabel:"Got it",hintShowButton:true,hintAutoRefreshInterval:10,hintAnimation:true,buttonClass:"introjs-button",progressBarAdditionalClass:false}}Ht({target:"Array",proto:true,forced:os||!ls||!cs||!ds},{sort:function e(t){if(t!==undefined)Q(t);var a=de(this);if(ds)return t===undefined?ns(a):ns(a,t);var r=[];var i=Ct(a);var n,s;for(s=0;s<i;s++)if(s in a)ss(r,a[s]);Xn(r,fs(t));n=r.length;s=0;while(s<n)a[s]=r[s++];while(s<i)delete a[s++];return a}});var Ss=function e(t){var a;if(i(t)==="object")a=new ks(t);else if(typeof t==="string"){var r=document.querySelector(t);if(r)a=new ks(r);else throw new Error("There is no element with given selector.")}else a=new ks(document.body);e.instances[n(a,"introjs-instance")]=a;return a};return Ss.version="4.3.0",Ss.instances={},Ss.fn=ks.prototype={clone:function e(){return new ks(this)},setOption:function e(t,a){this._options[t]=a;return this},setOptions:function e(t){this._options=a(this._options,t);return this},start:function e(){ws.call(this,this._targetElement);return this},goToStep:function e(t){In.call(this,t);return this},addStep:function e(t){if(!this._options.steps)this._options.steps=[];this._options.steps.push(t);return this},addSteps:function e(t){if(!t.length)return;for(var a=0;a<t.length;a++)this.addStep(t[a]);return this},goToStepNumber:function e(t){En.call(this,t);return this},nextStep:function e(){xn.call(this);return this},previousStep:function e(){jn.call(this);return this},currentStep:function e(){return Dn.call(this)},exit:function e(t){bs.call(this,this._targetElement,t);return this},refresh:function e(t){ms.call(this,t);return this},onbeforechange:function e(t){if(typeof t==="function")this._introBeforeChangeCallback=t;else throw new Error("Provided callback for onbeforechange was not a function");return this},onchange:function e(t){if(typeof t==="function")this._introChangeCallback=t;else throw new Error("Provided callback for onchange was not a function.");return this},onafterchange:function e(t){if(typeof t==="function")this._introAfterChangeCallback=t;else throw new Error("Provided callback for onafterchange was not a function");return this},oncomplete:function e(t){if(typeof t==="function")this._introCompleteCallback=t;else throw new Error("Provided callback for oncomplete was not a function.");return this},onhintsadded:function e(t){if(typeof t==="function")this._hintsAddedCallback=t;else throw new Error("Provided callback for onhintsadded was not a function.");return this},onhintclick:function e(t){if(typeof t==="function")this._hintClickCallback=t;else throw new Error("Provided callback for onhintclick was not a function.");return this},onhintclose:function e(t){if(typeof t==="function")this._hintCloseCallback=t;else throw new Error("Provided callback for onhintclose was not a function.");return this},onstart:function e(t){if(typeof t==="function")this._introStartCallback=t;else throw new Error("Provided callback for onstart was not a function.");return this},onexit:function e(t){if(typeof t==="function")this._introExitCallback=t;else throw new Error("Provided callback for onexit was not a function.");return this},onskip:function e(t){if(typeof t==="function")this._introSkipCallback=t;else throw new Error("Provided callback for onskip was not a function.");return this},onbeforeexit:function e(t){if(typeof t==="function")this._introBeforeExitCallback=t;else throw new Error("Provided callback for onbeforeexit was not a function.");return this},addHints:function e(){Hn.call(this,this._targetElement);return this},hideHint:function e(t){$n.call(this,t);return this},hideHints:function e(){Mn.call(this);return this},showHint:function e(t){Ln.call(this,t);return this},showHints:function e(){zn.call(this);return this},removeHints:function e(){Bn.call(this);return this},removeHint:function e(t){Fn().call(this,t);return this},showHintDialog:function e(t){Wn.call(this,t);return this}},Ss}();var introJs=intro.exports;const ZWEI={templates:{skill:"systems/zweihander/templates/chat/chat-skill.hbs",spell:"systems/zweihander/templates/chat/chat-spell.hbs",parry:"systems/zweihander/templates/chat/chat-parry.hbs",dodge:"systems/zweihander/templates/chat/chat-dodge.hbs",weapon:"systems/zweihander/templates/chat/chat-weapon.hbs",skillConfigurationDialog:"systems/zweihander/templates/dialog/dialog-skill-configuration.hbs",spellConfigurationDialog:"systems/zweihander/templates/dialog/dialog-spell-configuration.hbs",weaponConfigurationDialog:"systems/zweihander/templates/dialog/dialog-weapon-configuration.hbs"},rollTypes:{skill:"skill",spell:"spell",parry:"parry",dodge:"dodge",weapon:"weapon"},testRollFormula:"1d100"};let fortuneTrackerApp;Hooks.once("socketlib.ready",()=>{FortuneTracker.registerPersistingSettings();var e=socketlib.registerSystem("zweihander");fortuneTrackerApp=new FortuneTracker(e)}),Hooks.once("ready",function(){var e=game.settings.get("zweihander","theme");game.settings.set("zweihander","theme",e),fortuneTrackerApp?.syncState(),migrateWorldSafe()}),Hooks.once("init",async function(){return console.log("Initializing ZWEIHÄNDER: Grim & Perilous RPG System"),game.zweihander={ZweihanderActor:ZweihanderActor,ZweihanderItem:ZweihanderItem,find:findItemsWorldWide,fortuneTrackerApp:fortuneTrackerApp,migrate:migrateWorld,introJs:introJs},CONFIG.ChatMessage.template="systems/zweihander/templates/chat/chat-message.hbs",CONFIG.Combat.initiative={formula:"1d10 + @stats.secondaryAttributes.initiative.current",decimals:2},CONFIG.ZWEI=ZWEI,CONFIG.Actor.documentClass=ZweihanderActor,CONFIG.Item.documentClass=ZweihanderItem,Actors.unregisterSheet("core",ActorSheet),Actors.registerSheet("zweihander",ZweihanderActorSheet,{types:["character"],makeDefault:!0}),Actors.registerSheet("zweihander",ZweihanderNpcSheet,{types:["npc"],makeDefault:!0}),Actors.registerSheet("zweihander",ZweihanderCreatureSheet,{types:["creature"],makeDefault:!0}),Items.unregisterSheet("core",ItemSheet),Items.registerSheet("zweihander",ZweihanderItemSheet,{makeDefault:!0}),registerSystemSettings(),await registerHandlebarHelpers(),preloadHandlebarsTemplates()}),Hooks.on("renderActorSheet",(e,t,a)=>{t.find(".header-button.configure-sheet").before(`
  <a class="configure-actor">
  <i class="fas fa-user-cog"></i>
  Actor
  </a>
  `),t.find(".configure-actor").click(()=>{new ZweihanderActorConfig(e.object).render(!0)})}),Hooks.on("renderChatLog",function(e,t,a){$(t).on("click",".link-details",e=>{e.preventDefault();const t=$(e.currentTarget);e=t.parents(".content").find(".roll-details");$(e).slideToggle()})});
//# sourceMappingURL=zweihander.js.map
